<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/hellomagento2/images/cropped-favicon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hellomagento2/images/cropped-favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hellomagento2/images/cropped-favicon-16x16.png">
  <link rel="mask-icon" href="/hellomagento2/images/cropped-favicon.svg" color="#222">

<link rel="stylesheet" href="/hellomagento2/css/main.css">


<link rel="stylesheet" href="/hellomagento2/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"piscesthankit.github.io","root":"/hellomagento2/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="{ Hello Magento 2 }">
<meta property="og:url" content="https://piscesthankit.github.io/hellomagento2/page/7/index.html">
<meta property="og:site_name" content="{ Hello Magento 2 }">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ThankIT">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://piscesthankit.github.io/hellomagento2/page/7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>{ Hello Magento 2 }</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/hellomagento2/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">{ Hello Magento 2 }</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">解决 Magento 2 应用问题，更注重深度挖掘。(ง •̀_•́)ง</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/hellomagento2/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/hellomagento2/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/hellomagento2/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/hellomagento2/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/magento-2-%E7%A7%BB%E9%99%A4-last-name/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/magento-2-%E7%A7%BB%E9%99%A4-last-name/" class="post-title-link" itemprop="url">Magento 2 移除 Last Name</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-11 16:23:55" itemprop="dateCreated datePublished" datetime="2018-08-11T16:23:55+08:00">2018-08-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/Magento-%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Magento 开发教程</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>包括两个部分:</p>
<ul>
<li>Customer 账户中的 Last Name</li>
<li>Customer Address 中的 Last Name</li>
</ul>
<p>这两个字段在数据库中是有字段来控制它是否必填和显隐的。 <code>eav_attribute</code> 中的 <code>is_required</code> 控制是否必填 <code>customer_eav_attribute</code> 中的 <code>is_visible</code> 控制显隐 通过下面的代码即可将 Last Name 设置成非必填项并隐藏。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace Vendor\ModuleName\Setup;</span><br><span class="line"></span><br><span class="line">use Magento\Framework\Setup\InstallDataInterface;</span><br><span class="line">use Magento\Framework\Setup\ModuleContextInterface;</span><br><span class="line">use Magento\Framework\Setup\ModuleDataSetupInterface;</span><br><span class="line"></span><br><span class="line">class InstallData implements InstallDataInterface</span><br><span class="line">&#123;</span><br><span class="line">    protected $eavSetupFactory;</span><br><span class="line"></span><br><span class="line">    public function __construct(</span><br><span class="line">        \Magento\Eav\Setup\EavSetupFactory $eavSetupFactory</span><br><span class="line">    )</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;eavSetupFactory = $eavSetupFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function install(</span><br><span class="line">        ModuleDataSetupInterface $setup,</span><br><span class="line">        ModuleContextInterface $context</span><br><span class="line">    ) &#123;</span><br><span class="line">        $eavSetup = $this-&gt;eavSetupFactory-&gt;create([&#x27;setup&#x27; =&gt; $setup]);</span><br><span class="line">        //update lastname to be not required and invisible</span><br><span class="line">        $eavSetup-&gt;updateAttribute(&#x27;customer&#x27;, &#x27;lastname&#x27;, &#x27;is_required&#x27;, 0);</span><br><span class="line">        $eavSetup-&gt;updateAttribute(&#x27;customer&#x27;, &#x27;lastname&#x27;, &#x27;is_visible&#x27;, 0);</span><br><span class="line">        $eavSetup-&gt;updateAttribute(&#x27;customer_address&#x27;, &#x27;lastname&#x27;, &#x27;is_required&#x27;, 0);</span><br><span class="line">        $eavSetup-&gt;updateAttribute(&#x27;customer_address&#x27;, &#x27;lastname&#x27;, &#x27;is_visible&#x27;, 0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过测试，所有通过 UI Component 加载的控件都可以正常工作了。比如管理后台，checkout 中。 还有用户注册页，用户后台账户页，可以通过 css 方式隐藏 Last Name</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.field-name-lastname &#123;</span><br><span class="line">    display: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外用户后台创建 Customer Address 会报错 <code>lastname is a required field.</code> 这是因为 <code>Magento\Customer\Model\Address\AbstractAddress::validate</code> 中需要验证 lastname 我们可以通过 plugin 来 unset 掉这个错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;config xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:framework:ObjectManager/etc/config.xsd&quot;&gt;</span><br><span class="line">    &lt;type name=&quot;Magento\Customer\Model\Address\AbstractAddress&quot;&gt;</span><br><span class="line">        &lt;plugin name=&quot;removelastname&quot; type=&quot;Vendor\ModuleName\Plugin\Address\AbstractAddress&quot; sortOrder=&quot;1&quot; /&gt;</span><br><span class="line">    &lt;/type&gt;</span><br><span class="line">&lt;/config&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace Vendor\ModuleName\Plugin\Address;</span><br><span class="line"></span><br><span class="line">class AbstractAddress &#123;</span><br><span class="line">    public function afterValidate(\Magento\Customer\Model\Address\AbstractAddress $subject, $result)</span><br><span class="line">    &#123;</span><br><span class="line">        $obj = __(&#x27;%fieldName is a required field.&#x27;, [&#x27;fieldName&#x27; =&gt; &#x27;lastname&#x27;]);</span><br><span class="line"></span><br><span class="line">        if (is_array($result)) &#123;</span><br><span class="line"></span><br><span class="line">            foreach ($result as $key =&gt; $value)</span><br><span class="line">            &#123;</span><br><span class="line">                if ($obj == $value) &#123;</span><br><span class="line">                    unset($result[$key]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (empty($result)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return $result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大功告成。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/alan-magento-2-ec6-template-literals/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/alan-magento-2-ec6-template-literals/" class="post-title-link" itemprop="url">Magento 2 ES6 Template Literals</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-09 09:54:16" itemprop="dateCreated datePublished" datetime="2018-07-09T09:54:16+08:00">2018-07-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/alan-storm/" itemprop="url" rel="index"><span itemprop="name">alan storm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://alanstorm.com/magento_2_ec6_template_literals/">原文地址</a> 今天我们将了解 ES6 template literals （模板字符串）。Template literals 是 javascript 的新特性，Magento 2 的 UI Component 系统部分核心功能依赖它。Template literals 本身就是一个需要理解的重要概念，但是更重要的是要理解 Magento 在 template literals 之上创建的额外抽象层。还有 Magento 的 <code>uiClass</code> object system 是怎么把它吸收进来的。 开始前，需要感谢 “bassplayer7” ，他在 <a target="_blank" rel="noopener" href="https://magento.stackexchange.com/questions/137689/sigil-strings-in-magento-2s-requirejs-files/137716#137716">StackExchange 上的回答</a>，提供了完成该篇文章所需要的重要信息。</p>
<h2 id="ES6-Template-Literals"><a href="#ES6-Template-Literals" class="headerlink" title="ES6 Template Literals"></a><a href="#es6-template-literals"></a>ES6 Template Literals</h2><p>很多人的第一个问题可能是 —— ES6 是什么鬼？ ES 是 ECMAScript 的缩写，ECMA 是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ecma_International">Ecma_International</a> 的缩写，他是一个将各种 javascript&#x2F;jscript&#x2F;actionscript 编程语言标准化的机构。 <a target="_blank" rel="noopener" href="http://es6-features.org/#Constants">ECMAScript 6</a> 是该标准的最新版本。浏览器厂商（Apple, Google, Firefox）正在根据 ES6 标准实现功能（类似于 HTML 是怎样推出的）。 其中一个功能正是 template literals 。Template literals 让 javascript 具备了简单的、内置的模板语言。我们将在 Google Chrome Console 中运行一些 template literal 示例代码，但是你是可以在任何支持 ES6 标准的 javascript 环境中运行这些示例代码的。 Template literals 最简单的形式和字符串的区别很小。看下面的<code>Hello World</code> 文本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; results = `Hello World`</span><br><span class="line">&gt; console.log(results);</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>

<p>注意，我们把 “Hello World” 放在了重音符中（就是这个符号：<strong>`</strong> 中） 放在重音符中的文本表示，这个字符串是一个 template literal 到目前为止，字符串和模板字符串（Template literal）没什么特别大的区别。Template literals are (from a userland perspective) immediately rendered as strings</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; var results = `Hello World`</span><br><span class="line">&gt; var type    = typeof results;</span><br><span class="line">&gt; console.log(type)</span><br><span class="line">string</span><br></pre></td></tr></table></figure>

<p><code>results</code> 变量看起来和 string 没什么区别，反正到目前为止，template literals 看起来没什么用。 当然了，如果他们没有什么用的话，我们也不会写文章说它了。Template literals 支持 <strong>template variables&#x2F;placeholders</strong> ，看下面的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; var salutation = &quot;Goodbye&quot;</span><br><span class="line">&gt; var results = `$&#123;salutation&#125; World`</span><br><span class="line">&gt; console.log(results);</span><br></pre></td></tr></table></figure>

<p><code>$&#123;salutation&#125;</code> 就是一个 template literal variable (or placeholder) 这些变量从 js 当前作用域中获得。所以 js 会把 <code>$&#123;salutation&#125;</code> 替换成 <code>Goodbye</code> 。 js 会这么做是因为我们给全局变量 <code>salutation</code> 赋值为 <code>Goodbye</code> 。 要了解更多 template literals <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">请访问 Mozilla developer network</a> ，会讲更多高级特性，比如 <code>tag</code> 。</p>
<h2 id="Browser-Support-and-Magento-2"><a href="#Browser-Support-and-Magento-2" class="headerlink" title="Browser Support and Magento 2"></a><a href="#browser-support-and-magento-2"></a>Browser Support and Magento 2</h2><p>跟其他 js 新特性一样，客户端开发者在使用前需要特别注意浏览器是否支持该特性。目前不是所有浏览器都支持 Template literals ，在老的浏览器上使用他们会导致错误。 Magento 2 的开发者通过创建 RequireJS 模块来 rendering template literals 去绕过使用限制。这个模块的 id 就是 <code>mage/utils/template</code> ，所以你可以像下面这样使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 注意要在 Magento 页面中打开 debugger</span><br><span class="line">//requires an enviornment bootstrapped with Magento 2</span><br><span class="line">//javascript.  i.e. open you debugger on a Magento page</span><br><span class="line"></span><br><span class="line">&gt; requirejs([&#x27;mage/utils/template&#x27;], function(templateRenderer)&#123;</span><br><span class="line">    window.salutation      = &#x27;Brave New&#x27;;</span><br><span class="line">    var templateLiteral = &#x27;$&#123;salutation&#125; World&#x27;;</span><br><span class="line">    var results         = templateRenderer.template(templateLiteral);</span><br><span class="line">    console.log(results);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Brave New World</span><br></pre></td></tr></table></figure>

<p>幕后，<code>mage/utils/template</code> 模块会检查浏览器对 template literal 的支持。如果支持，模块将使用浏览器原生的实现方式，如果不支持，模块将使用纯用户级的实现方式（速度更慢一点）。<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Polyfill">这被称为 polyfill</a> 这个模块很有用，但是有几点需要说明。首先，你会注意到我们需要把 <code>salutation</code> 变量搁到全局的命名空间上（在浏览器的 js 环境下指的是 “window”）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">window.salutation      = &#x27;Brave New&#x27;;</span><br><span class="line">var templateLiteral = &#x27;$&#123;salutation&#125; World&#x27;;</span><br></pre></td></tr></table></figure>

<p>原生的 template literals 会从当前作用域取值，但是 Magento 2 的模块（任何用户级代码）则不能自动地访问该作用域，因此，template literals 只能从全局作用域上取值。 看下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; requirejs([&#x27;mage/utils/template&#x27;], function(templateRenderer)&#123;</span><br><span class="line">        var salutation      = &#x27;Brave New&#x27;;</span><br><span class="line">        var templateLiteral = &#x27;$&#123;salutation&#125; World&#x27;;</span><br><span class="line">        var results         = templateRenderer.template(templateLiteral);</span><br><span class="line">        console.log(results);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>这里会报错(除非你定义了一个全局变量 salutation)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">VM1627:1 Uncaught ReferenceError: salutation is not defined</span><br></pre></td></tr></table></figure>

<p>（这一段我也没看懂，所以放上原文） The second mage&#x2F;utils&#x2F;template caveat, and likely a direct result of the above scope problem, is Magento 2’s template literals have extra abilities that go above and beyond those defined in the standard.</p>
<h2 id="Binding-View-Variables-to-a-Template-Literal"><a href="#Binding-View-Variables-to-a-Template-Literal" class="headerlink" title="Binding View Variables to a Template Literal"></a><a href="#binding-view-variables-to-a-template-literal"></a>Binding View Variables to a Template Literal</h2><p>Magento 2 的 template litearls 允许你绑定特定的对象到特定的 template literal 上，然后通过特别的语法引用变量。就像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; requirejs([&#x27;mage/utils/template&#x27;], function(templateRenderer)&#123;</span><br><span class="line">        var viewVars        = &#123;</span><br><span class="line">            &#x27;salutation&#x27;:&#x27;What a Crazy&#x27;</span><br><span class="line">        &#125;;</span><br><span class="line">        var templateLiteral = &#x27;$&#123;salutation&#125; World&#x27;;</span><br><span class="line">        var results         = templateRenderer.template(templateLiteral, viewVars);</span><br><span class="line">        console.log(results);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>就是说，<code>template</code> 方法第二个参数接受一个对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templateRenderer.template(templateLiteral, viewVars);</span><br></pre></td></tr></table></figure>

<p>但是上面的代码还是会报错。这是因为我们前面说过要用特殊的语法的。你需要在 <code>$&#123;&#125;</code> 里面用第二个 <code>$</code> 符号来引用对象。 就是说下面这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var templateLiteral = &#x27;$&#123;salutation&#125; World&#x27;;</span><br></pre></td></tr></table></figure>

<p>需要变成这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var templateLiteral = &#x27;$&#123;$.placeholder&#125; World&#x27;;</span><br></pre></td></tr></table></figure>

<p>这有点笨拙，不过还是很好理解的，只要明白 <code>$.</code> 指代你传递过去的对象。 下面这样就对了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">requirejs([&#x27;mage/utils/template&#x27;], function(templateRenderer)&#123;</span><br><span class="line">        var viewVars        = &#123;</span><br><span class="line">            &#x27;salutation&#x27;:&#x27;What a Crazy&#x27;</span><br><span class="line">        &#125;;</span><br><span class="line">        var templateLiteral = &#x27;$&#123;$.salutation&#125; World&#x27;;</span><br><span class="line">        var results         = templateRenderer.template(templateLiteral, viewVars);</span><br><span class="line">        console.log(results);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">What a Crazy World</span><br></pre></td></tr></table></figure>

<h2 id="Connection-to-UI-Components"><a href="#Connection-to-UI-Components" class="headerlink" title="Connection to UI Components"></a><a href="#connection-to-ui-components"></a>Connection to UI Components</h2><p>为什么我们要在讲 Magento 2 的 UI Component 系列文章中讲 template literals 呢？这是因为 template literals 已经被植入了 view model constructor object 系统中。 我们知道，Magento UI Components 使用的 Knockout.js view model constructor objects 是基于 <code>uiElement/Magento_Ui/js/lib/core/element/element</code> 模块的。(<a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan_magento_2_simplest_ui_knockout_component/#configuring-a-view-model-constructor">不明白戳这里</a>) 下面是一个简单的例子，我们先创建一个 view model constructor ，然后用这个 constructor 去创建 view model</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; requirejs([&#x27;uiElement&#x27;], function(Element)&#123;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;&#125;);</span><br><span class="line">    viewModel = new viewModelConstructor;</span><br><span class="line">    console.log(viewModel);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">UiClass &#123;_super: undefined, ignoreTmpls: Object, ...&#125;</span><br></pre></td></tr></table></figure>

<p>这个 view model constructor 有能力带 default 值进行实例化（因为 <code>uiElement</code> 继承自 <code>uiClass/Magento_Ui/js/lib/core/class</code>，这个父类是拥有这个能力的）如果你为 view model constructor 提供 default object ，像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">viewModelConstructor = Element.extend(&#123;</span><br><span class="line">    &#x27;defaults&#x27;:&#123;</span><br><span class="line">        &#x27;ourDefaultValue&#x27;:&#x27;Look at our value!&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>那么所有通过这个 constructor 实例化的对象都会拥有 default 值 ourDefaultValue</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; requirejs([&#x27;uiElement&#x27;], function(Element)&#123;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;</span><br><span class="line">        &#x27;defaults&#x27;:&#123;</span><br><span class="line">            &#x27;ourDefaultValue&#x27;:&#x27;Look at our value!&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    viewModel = new viewModelConstructor;</span><br><span class="line">    console.log(viewModel.ourDefaultValue);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Look at our value!</span><br></pre></td></tr></table></figure>

<p>Magento 对象系统会是检查所有的 default 字符串，发现 template literal 就会自动计算出他们。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; requirejs([&#x27;uiElement&#x27;], function(Element)&#123;</span><br><span class="line">    window.salutation = &#x27;Hello&#x27;;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;</span><br><span class="line">        &#x27;defaults&#x27;:&#123;</span><br><span class="line">            &#x27;message&#x27;:&#x27;$&#123;salutation&#125; World. &#x27;,</span><br><span class="line">            &#x27;salutation&#x27;:&#x27;Goodbye&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    viewModel = new viewModelConstructor;</span><br><span class="line">    console.log(viewModel.message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Hello World.</span><br></pre></td></tr></table></figure>

<p>注意这里使用的是全局的 <code>salutation</code> 值。 看下面的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">requirejs([&#x27;uiElement&#x27;], function(Element)&#123;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;</span><br><span class="line">        &#x27;defaults&#x27;:&#123;</span><br><span class="line">            &#x27;message&#x27;:&#x27;$&#123;$.salutation&#125; World. &#x27;,</span><br><span class="line">            &#x27;salutation&#x27;:&#x27;Goodbye&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    viewModel = new viewModelConstructor;</span><br><span class="line">    console.log(viewModel.message);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Goodbye World.</span><br></pre></td></tr></table></figure>

<p>给 view model constructor 传递对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">requirejs([&#x27;uiElement&#x27;], function(Element)&#123;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;</span><br><span class="line">        &#x27;defaults&#x27;:&#123;</span><br><span class="line">            &#x27;message&#x27;:&#x27;$&#123;$.salutation&#125; World. &#x27;,</span><br><span class="line">            &#x27;salutation&#x27;:&#x27;Goodbye&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    viewModel = new viewModelConstructor(&#123;</span><br><span class="line">        &#x27;salutation&#x27;:&#x27;This is still a crazy&#x27;</span><br><span class="line">    &#125;);</span><br><span class="line">    console.log(viewModel.message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">This is still a crazy World.</span><br></pre></td></tr></table></figure>

<h2 id="Wrap-Up"><a href="#Wrap-Up" class="headerlink" title="Wrap Up"></a><a href="#wrap-up"></a>Wrap Up</h2><p>本文揭示了想把 Magento 当作平台使用的开发者遇到的挑战之一。不仅有前沿 javaScript 概念，还有 Magento 通过不那么标准的方式(binding view variables)去扩展了这些概念，还有 Magento 是如何将这些概念吸收到自己的系统中去的（<code>uiClass</code> object system）。 如果没有上面的这些概念，那么你遇到下面这些代码的时候：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">return Element.extend(&#123;</span><br><span class="line">    defaults: &#123;</span><br><span class="line">        clientConfig: &#123;</span><br><span class="line">            urls: &#123;</span><br><span class="line">                save: &#x27;$&#123; $.submit_url &#125;&#x27;,</span><br><span class="line">                beforeSave: &#x27;$&#123; $.validate_url &#125;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>就只能摸不着头脑干着急了。 现在我们了解了 Magento 的 ES6-like template literals .我们距离更进一步的探索又近了一步，下面我们将探索 Magento 是如何将后端数据放入 view model constructor 的 <code>default</code> 数组中的，还有 Magento 是如何处理 UI Component 生成的 data sources 的。 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34270829/chrome-console-clear-assignment-and-variables">chrome console 中 var 声明的也是全局变量</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/alan-magento-2s-base-javascript-class/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/alan-magento-2s-base-javascript-class/" class="post-title-link" itemprop="url">Magento 2’s Base Javascript Class</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-09 09:44:21" itemprop="dateCreated datePublished" datetime="2018-07-09T09:44:21+08:00">2018-07-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/alan-storm/" itemprop="url" rel="index"><span itemprop="name">alan storm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://alanstorm.com/magento-2s-base-javascript-class/">原文地址</a></p>
<p>Magento 2 的核心 javascript library 实现了一个基于类的基础 object system（Magento 2’s core javascript library ships with a basic implementation of a class based object system），uiComponent 广泛地使用了这些基本类和对象。这个基本类就是 <code>Magento_Ui/js/lib/core/class</code> ，你可以通过 javascript 的 <code>new</code> 关键字来创建这个基础类的实例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; requirejs([</span><br><span class="line">    &#x27;Magento_Ui/js/lib/core/class&#x27;,</span><br><span class="line">], function (Class) &#123;</span><br><span class="line">    &#x27;use strict&#x27;;</span><br><span class="line">    var o = new Class;</span><br><span class="line">    console.log(o);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">UiClass &#123;ignoreTmpls: &#123;…&amp;#125;&amp;#125;</span><br></pre></td></tr></table></figure>

<p>你可以使用基础类的 <code>extend</code> 方法去创建子类。通过 <code>extend</code> 方法传递 key&#x2F;function 对去定义方法。Magento 的对象有一个类似 constructor 的方法叫做 <code>initialize</code>，它在实例化对象的时候被调用。你可以通过 <code>this._super()</code> 来调用父类的方法。只能在方法体中调用 <code>_super</code> —— 该方法并不是”公有的” (not exposed publicly)</p>
<p>在下面的例子中，我们定义两个类 A 和 B 。 A 继承基础类，B 继承 A，定义好类以后，我们实例化一个 B 类，然后调用该对象的 hello 方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">requirejs([</span><br><span class="line">    &#x27;Magento_Ui/js/lib/core/class&#x27;,</span><br><span class="line">], function (Class) &#123;</span><br><span class="line">    &#x27;use strict&#x27;;</span><br><span class="line"></span><br><span class="line">    var A = Class.extend(&#123;</span><br><span class="line">        initialize: function () &#123;</span><br><span class="line">            this._super();</span><br><span class="line">            console.log(&quot;Called A&#x27;s initialize/constructor&quot;);</span><br><span class="line">            this.foo = &quot;foo&quot;;</span><br><span class="line">            this.bar = &quot;bar&quot;;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        hello: function()&#123;</span><br><span class="line">            console.log(&quot;Hello&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    var B = A.extend(&#123;</span><br><span class="line">        initialize: function () &#123;</span><br><span class="line">            this._super();</span><br><span class="line">            console.log(&quot;Called B&#x27;s initialize/constructor&quot;);</span><br><span class="line">            this.bar = &quot;BIG BAR&quot;;</span><br><span class="line">            this.baz = &quot;baz&quot;;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        hello: function()&#123;</span><br><span class="line">            this._super();</span><br><span class="line">            console.log(&quot;Hello Again&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    var object = new B;</span><br><span class="line">    object.hello();</span><br><span class="line">    console.log(object);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Called A&#x27;s initialize/constructor</span><br><span class="line">Called B&#x27;s initialize/constructor</span><br><span class="line">Hello</span><br><span class="line">Hello Again</span><br><span class="line">UiClass &#123;_super: undefined, ignoreTmpls: &#123;…&#125;, foo: &quot;foo&quot;, bar: &quot;BIG BAR&quot;, baz: &quot;baz&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><code>Magento_Ui/js/lib/core/class</code> 的别名是 <code>uiClass</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vendor/magento/module-ui/view/base/requirejs-config.js</span><br><span class="line">15:            uiClass:        &#x27;Magento_Ui/js/lib/core/class&#x27;,</span><br></pre></td></tr></table></figure>

<p>所以下面这样也是等价的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">requirejs([</span><br><span class="line">    &#x27;uiClass&#x27;,</span><br><span class="line">], function (Class) &#123;</span><br><span class="line">    &#x27;use strict&#x27;;</span><br><span class="line">    o = new Class;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>lib/core/element/element</code>(别名 <code>uiElement</code>) 继承自 <code>Magento_Ui/js/lib/core/class</code>，而 <code>lib/core/collection</code> (别名 <code>uiComponent</code>) 继承自 <code>uiElement</code></p>
<p>讲解基础类的是怎么实现的超出了本文的范围。不过 <code>extend</code> 方法是通过 Underscore JS 实现的，<code>_super</code> 则来自于 <code>mage/utils/wrapper</code> (也就是 <code>lib/web/mage/utils/wrapper.js</code>)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/alan-magento-2-simplest-xsd-valid-ui-component/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/alan-magento-2-simplest-xsd-valid-ui-component/" class="post-title-link" itemprop="url">Magento 2: Simplest XSD Valid UI Component</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-10 08:52:39" itemprop="dateCreated datePublished" datetime="2018-06-10T08:52:39+08:00">2018-06-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/alan-storm/" itemprop="url" rel="index"><span itemprop="name">alan storm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://alanstorm.com/magento_2_simplest_xsd_valid_ui_component/">原文地址</a> 上期的两篇文章中，我们从头创建了一个新的 UI Component 模块。虽然我们成功了，但是是以 <code>&lt;preference&gt;</code> 重写的方式做到的，这种方式禁用了 Magento 2 的 XSD 验证的，作为学习练习还好，但不能用在生产环境中。 使用 <code>&lt;preference&gt;</code> 的方式禁用 XSD 验证是以牺牲系统的稳定性为代价的。这次我们不会再禁用 XSD 的验证，用可以在生产环境中使用的方式来创建 UI Component</p>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a><a href="#%E5%89%8D%E6%8F%90"></a>前提</h2><p>如果上次你已经使用了 <code>Pulsestorm_SimpleUiComponent</code> 那么现在请禁用该模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ php bin/magento module:disable Pulsestorm_SimpleUiComponent</span><br><span class="line">The following modules have been disabled:</span><br><span class="line">- Pulsestorm_SimpleUiComponent</span><br><span class="line"></span><br><span class="line">Cache cleared successfully.</span><br><span class="line">Generated classes cleared successfully. Please run the &#x27;setup:di:compile&#x27; command to generate classes.</span><br><span class="line">Info: Some modules might require static view files to be cleared. To do this, run &#x27;module:disable&#x27; with the --clear-static-content option to clear them.</span><br></pre></td></tr></table></figure>

<p>下面我们使用 <a target="_blank" rel="noopener" href="https://github.com/astorm/pestle">pestle</a> 创建一个 Admin 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">php pestle.phar generate_module Pulsestorm SimpleValidUiComponent 0.0.1</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_acl Pulsestorm_SimpleValidUiComponent Pulsestorm_SimpleValidUiComponent::top,Pulsestorm_SimpleValidUiComponent::menu_1</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_menu Pulsestorm_SimpleValidUiComponent Magento_Backend::system_other_settings Pulsestorm_SimpleValidUiComponent::a_menu_item Pulsestorm_SimpleValidUiComponent::menu_1 &quot;Hello Simple Valid Ui Component&quot; pulsestorm_simplevaliduicomponent/index/index 1</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_route Pulsestorm_SimpleValidUiComponent adminhtml pulsestorm_simplevaliduicomponent</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_view Pulsestorm_SimpleValidUiComponent adminhtml pulsestorm_simplevaliduicomponent_index_index Main content.phtml 1column</span><br><span class="line"></span><br><span class="line">php bin/magento module:enable Pulsestorm_SimpleValidUiComponent</span><br><span class="line"></span><br><span class="line">php bin/magento setup:upgrade</span><br></pre></td></tr></table></figure>

<p>这样，我们登陆管理后台，进入 <code>System -&gt; Other Settings -&gt; Hello Simple Valid Ui Component</code> OK ，我们的模板已经生成了，下面开始进入正题。</p>
<h2 id="A-New-UI-Component"><a href="#A-New-UI-Component" class="headerlink" title="A New UI Component"></a><a href="#a-new-ui-component"></a>A New UI Component</h2><p>我们在 layout handle XML 文件中加入新的 <code>&lt;uiComponent&gt;</code> 节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/layout/pulsestorm_simplevaliduicomponent_index_index.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;page xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:framework:View/Layout/etc/page_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;referenceBlock name=&quot;content&quot;&gt;</span><br><span class="line">        &lt;block template=&quot;content.phtml&quot; class=&quot;Pulsestorm\SimpleValidUiComponent\Block\Adminhtml\Main&quot; name=&quot;pulsestorm_simplevaliduicomponent_block_main&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;uiComponent name=&quot;pulsestorm_simple_valid&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/referenceBlock&gt;</span><br><span class="line">&lt;/page&gt;</span><br></pre></td></tr></table></figure>

<p>然后我们创建这个名为 <code>pulsestorm_simple_valid</code> 的 UI Component 的 XML 文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/ui_component/pulsestorm_simple_valid.xml</span><br><span class="line">&lt;pulsestorm_simple_valid xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">&lt;/pulsestorm_simple_valid&gt;</span><br></pre></td></tr></table></figure>

<p>清空缓存刷新页面，我们会看到如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception #0 (Magento\Framework\Exception\LocalizedException): Element</span><br><span class="line">&#x27;pulsestorm_simple_valid&#x27;: No matching global declaration</span><br><span class="line">available for thevalidation root.</span><br></pre></td></tr></table></figure>

<p>就像我们之前的文章中说的那样，这个错误是因为 <code>vendor/magento/module-ui/view/base/ui_component/etc/definition.xml</code> 中没有定义 <code>pulsestorm_simple_valid</code> ，而且我们没有办法增加这个节点进去，因为 Magento 的 XSD 验证不能通过名为 <code>&lt;pulsestorm_simple_valid/&gt;</code> 的 root 节点。 在 2.1 版本的 Magento 中，我们是没有好办法不动系统方法去做到的增加 root 节点的，但是我们可以变通一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/ui_component/pulsestorm_simple_valid.xml</span><br><span class="line">&lt;container xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">&lt;/container&gt;</span><br></pre></td></tr></table></figure>

<p><code>&lt;container&gt;</code> 节点是一个有效的 root 节点，清空缓存刷新页面，我们这次会看到如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Fatal error: Method Magento\Ui\TemplateEngine\Xhtml\Result::__toString()</span><br><span class="line">must not throw an exception, caught Error: Call to a member function</span><br><span class="line">getConfigData() on null in</span><br><span class="line">/path/to/magento/vendor/magento/module-ui/</span><br><span class="line">Component/Wrapper/UiComponent.php on line 0</span><br></pre></td></tr></table></figure>

<p>换句话说，schema validation 错误已经没有了，这次只是因为缺少 <code>dataSource</code> 节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/ui_component/pulsestorm_simple_valid.xml</span><br><span class="line">&lt;container xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;dataSource name=&quot;pulsestorm_simple_valid_data_source&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;dataProvider&quot; xsi:type=&quot;configurableObject&quot;&gt;</span><br><span class="line">            &lt;!-- the PHP class that implements a data provider --&gt;</span><br><span class="line">            &lt;argument name=&quot;class&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm\SimpleValidUiComponent\Model\DataProvider&lt;/argument&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- redundant with the `dataSource` name --&gt;</span><br><span class="line">            &lt;argument name=&quot;name&quot; xsi:type=&quot;string&quot;&gt;pulsestorm_simple_valid_data_source&lt;/argument&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- required: means ui components are meant to work with models --&gt;</span><br><span class="line">            &lt;argument name=&quot;primaryFieldName&quot; xsi:type=&quot;string&quot;&gt;entity_id&lt;/argument&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- required: means ui components are meant to work with URL passing --&gt;</span><br><span class="line">            &lt;argument name=&quot;requestFieldName&quot; xsi:type=&quot;string&quot;&gt;id&lt;/argument&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/dataSource&gt;</span><br><span class="line">&lt;/container&gt;</span><br></pre></td></tr></table></figure>

<p>data provider class</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/Model/DataProvider.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleValidUiComponent\Model;</span><br><span class="line">class DataProvider extends \Magento\Ui\DataProvider\AbstractDataProvider</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>刷新页面，这次我们应该没有错误，加载了页面了。</p>
<h2 id="What-Did-We-Render"><a href="#What-Did-We-Render" class="headerlink" title="What Did We Render?"></a><a href="#what-did-we-render?"></a>What Did We Render?</h2><p>如果我们查看源代码的话，不是通过 DOM Inspector ，我们会看到下面的加载内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;div data-bind=&quot;scope: &#x27;pulsestorm_simple_valid.areas&#x27;&quot; class=&quot;entry-edit form-inline&quot;&gt;</span><br><span class="line">        &lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;script type=&quot;text/x-magento-init&quot;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;*&quot;: &#123;</span><br><span class="line">            &quot;Magento_Ui/js/core/app&quot;: &#123;</span><br><span class="line">                &quot;types&quot;: &#123;</span><br><span class="line">                    &quot;dataSource&quot;: [],</span><br><span class="line">                    &quot;container&quot;: &#123;</span><br><span class="line">                        &quot;extends&quot;: &quot;pulsestorm_simple_valid&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;html_content&quot;: &#123;</span><br><span class="line">                        &quot;component&quot;: &quot;Magento_Ui\/js\/form\/components\/html&quot;,</span><br><span class="line">                        &quot;extends&quot;: &quot;pulsestorm_simple_valid&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;components&quot;: &#123;</span><br><span class="line">                    &quot;pulsestorm_simple_valid&quot;: &#123;</span><br><span class="line">                        &quot;children&quot;: &#123;</span><br><span class="line">                            &quot;pulsestorm_simple_valid&quot;: &#123;</span><br><span class="line">                                &quot;type&quot;: &quot;pulsestorm_simple_valid&quot;,</span><br><span class="line">                                &quot;name&quot;: &quot;pulsestorm_simple_valid&quot;,</span><br><span class="line">                                &quot;config&quot;: &#123;</span><br><span class="line">                                    &quot;component&quot;: &quot;uiComponent&quot;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &quot;pulsestorm_simple_valid_data_source&quot;: &#123;</span><br><span class="line">                                &quot;type&quot;: &quot;dataSource&quot;,</span><br><span class="line">                                &quot;name&quot;: &quot;pulsestorm_simple_valid_data_source&quot;,</span><br><span class="line">                                &quot;dataScope&quot;: &quot;pulsestorm_simple_valid&quot;,</span><br><span class="line">                                &quot;config&quot;: &#123;</span><br><span class="line">                                    &quot;params&quot;: &#123;</span><br><span class="line">                                        &quot;namespace&quot;: &quot;pulsestorm_simple_valid&quot;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>我们看下 <code>&lt;container&gt;</code> 在 <code>definition.xml</code> 配置中的定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: vendor/magento//module-ui/view/base/ui_component/etc/definition.xml --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- ... --&gt;</span><br><span class="line">&lt;container class=&quot;Magento\Ui\Component\Container&quot;&gt;</span><br><span class="line">    &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">        &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;uiComponent&lt;/item&gt;</span><br><span class="line">        &lt;/item&gt;</span><br><span class="line">        &lt;item name=&quot;template&quot; xsi:type=&quot;string&quot;&gt;templates/container/default&lt;/item&gt;</span><br><span class="line">    &lt;/argument&gt;</span><br><span class="line">&lt;/container&gt;</span><br><span class="line">&lt;!-- ... --&gt;</span><br></pre></td></tr></table></figure>

<p>他的 XHTML template 是 <code>templates/container/default</code> ，他的 component 是 <code>uiComponent</code> (<code>Magento_Ui/js/lib/core/collection</code>) 我们选择用 <code>container</code> component 的原因有两点：第一，他是少数几个能用的不会有 XSD 验证错误的 root 节点。第二，<code>uiComponent</code> 正是我们需要的组件。上次（<a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan_magento_2_simplest_ui_knockout_component/#why-the-double-name">Magento 2: Simplest UI Knockout Component</a>）我们讲到 <code>ui/collection</code> 模块会遍历子元素，并加载子元素的模板，类似于 layout update XML 的 <code>&lt;container&gt;</code> 节点，或者 Magento 1 中的 <code>core/text_list</code> block 但是 <code>templates/container/default</code> XHTML 模板并不是我们需要的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#File: vendor/magento/module-ui/view/base/ui_component/templates/container/default.xhtml</span><br><span class="line">&lt;div xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;../../../../../../Ui/etc/ui_template.xsd&quot;&gt;</span><br><span class="line">    &lt;div data-bind=&quot;scope: &#x27;&amp;#123;&amp;#123;getName()&amp;#125;&amp;#125;.areas&#x27;&quot; class=&quot;entry-edit form-inline&quot;&gt;</span><br><span class="line">        &lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>这个模板是干吗用的目前还不是很清楚。Magento 的 <code>ui_component</code> files 只用 <code>&lt;container&gt;</code> 作为子节点，就是说它的 XHTML template 从来没有被加载过。很有可能是早期 Magento 使用 <code>&lt;container&gt;</code> 作为 root 根节点的遗留产物，也可能是某种为将来做的准备。管他原因是什么，这就是为什么我们可以用 <code>&lt;container&gt;</code> 作为 root 节点。很难说这个“功能”以后还会不会存在，但目前这是最好的方式了。</p>
<h2 id="Changing-the-Template"><a href="#Changing-the-Template" class="headerlink" title="Changing the Template"></a><a href="#changing-the-template"></a>Changing the Template</h2><p>XHTML 模板不是我们想要的，那么我们是不是就卡住了呢？当然不是了，我们可以在 <code>ulsestorm_simple_valid.xml</code> 文件中配置一个新的模板。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/ui_component/pulsestorm_simple_valid.xml</span><br><span class="line">&lt;container xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">        &lt;item name=&quot;template&quot; xsi:type=&quot;string&quot;&gt;templates/pulsestorm_simple_valid/default&lt;/item&gt;</span><br><span class="line">    &lt;/argument&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/container&gt;</span><br></pre></td></tr></table></figure>

<p>记住，<code>definition.xml</code> 文件中设置的是默认值，<code>ui_component</code> 文件夹中的文件可以覆盖默认值。 然后我们还要创建 <code>xhtml</code> template</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/ui_component/templates/pulsestorm_simple_valid/default.xhtml</span><br><span class="line">&lt;div data-bind=&quot;scope: &#x27;&amp;#123;&amp;#123;getName()&amp;#125;&amp;#125;.&amp;#123;&amp;#123;getName()&amp;#125;&amp;#125;&#x27;&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:noNamespaceSchemaLocation=&quot;../../../../../../Ui/etc/ui_template.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>上面的代码基本上参照的是 listing grid (vendor&#x2F;magento&#x2F;module-ui&#x2F;view&#x2F;base&#x2F;ui_component&#x2F;templates&#x2F;listing&#x2F;default.xhtml) 的默认 XHTML 。它和我们上篇中用的模板一样，通过 <code>scope</code> 绑定将整个系统运行起来。 这里有几点值得注意。 首先，我们看到 Knockout tag-less 模板绑定：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;</span><br></pre></td></tr></table></figure>

<p>我们已经知道了 Knockout 的 view model 是通过我们的 <code>scope</code> 绑定来实现的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div data-bind=&quot;scope: &#x27;&amp;#123;&amp;#123;getName()&amp;#125;&amp;#125;.&amp;#123;&amp;#123;getName()&amp;#125;&amp;#125;&#x27;&quot; ...&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们看到了一个不熟悉的地方。我么用了 <code>&amp;#123;&amp;#123;getName()&amp;#125;&amp;#125;.&amp;#123;&amp;#123;getName()&amp;#125;&amp;#125;</code> 来替代了硬编码的 scope 绑定。<code>&amp;#123;&amp;#123;...&amp;#125;&amp;#125;</code> 花括号中的内容是 XHTML template 语言的一部分，他将调用该 UI Component 对象的 <code>getName()</code> 方法。这里的 name 是我们用在 layout handle XML 文件中的 <code>&lt;uiComponent name=&quot;pulsestorm_simple_valid&quot;/&gt;</code> 。就是说他等同于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div data-bind=&quot;scope: &#x27;pulsestorm_simple_valid.pulsestorm_simple_valid&#x27;&quot; ...&gt;</span><br></pre></td></tr></table></figure>

<p>下一处让人困惑的地方是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xsi:noNamespaceSchemaLocation=&quot;../../../../../../Ui/etc/ui_template.xsd&quot;</span><br></pre></td></tr></table></figure>

<p>We have an XML namespace declaration in the root level</p>
<p>, as well as a schema validation file (xsi:noNamespaceSchemaLocation).记住，这是 XHTML 不是 HTML 模板。他们像 XML 文件那样，这意味着 XHTML 模板中只能由一个 top level node . 虽然这些属性（namespace 等）不是严格要求的，但是 Magento 核心文件中都是有的，所以为了保持一致，我们最好也加上。 如果你很好奇，为什么这些属性最终没有进入到 HTML 中去的话，这是因为在加载前 Magento 移除了他们：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#File: vendor/magento/module-ui/TemplateEngine/Xhtml/Result.php</span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        //...</span><br><span class="line">        foreach ($templateRootElement-&gt;attributes as $name =&gt; $attribute) &#123;</span><br><span class="line">            if (&#x27;noNamespaceSchemaLocation&#x27; === $name) &#123;</span><br><span class="line">                $this-&gt;getDocumentElement()-&gt;removeAttributeNode($attribute);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $templateRootElement-&gt;removeAttributeNS(&#x27;http://www.w3.org/2001/XMLSchema-instance&#x27;, &#x27;xsi&#x27;);</span><br><span class="line">        //...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最后，<code>ui_template.xsd</code> 值得一看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#File: vendor/magento/module-ui/etc/ui_template.xsd</span><br><span class="line">&lt;xs:schema xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; elementFormDefault=&quot;qualified&quot;&gt;</span><br><span class="line">    &lt;xs:element name=&quot;form&quot;&gt;</span><br><span class="line">        &lt;xs:complexType &gt;</span><br><span class="line">            &lt;xs:sequence&gt;</span><br><span class="line">                &lt;xs:any minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot; processContents=&quot;lax&quot; /&gt;</span><br><span class="line">            &lt;/xs:sequence&gt;</span><br><span class="line">        &lt;/xs:complexType&gt;</span><br><span class="line">    &lt;/xs:element&gt;</span><br><span class="line">    &lt;xs:element name=&quot;div&quot; &gt;</span><br><span class="line">        &lt;xs:complexType &gt;</span><br><span class="line">            &lt;xs:sequence&gt;</span><br><span class="line">                &lt;xs:any minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot; processContents=&quot;lax&quot; /&gt;</span><br><span class="line">            &lt;/xs:sequence&gt;</span><br><span class="line">            &lt;xs:anyAttribute processContents=&quot;lax&quot; /&gt;</span><br><span class="line">        &lt;/xs:complexType&gt;</span><br><span class="line">    &lt;/xs:element&gt;</span><br><span class="line">&lt;/xs:schema&gt;</span><br></pre></td></tr></table></figure>

<p>完整地讲 <code>xs:schema</code> 语言超出了本篇的范围，但是上面地代码表示 <code>xhtml</code> 文件必须有一个 root 节点，<code>div</code> 或是 <code>form</code> 。另外，我们地文件中不写 <code>si:noNamespaceSchemaLocation</code> 并不能跳过验证，因为这些 <code>.xhtml</code> 文件最终会被合并成 XML 树，带 schema 验证的。</p>
<h2 id="Adding-to-the-Collection"><a href="#Adding-to-the-Collection" class="headerlink" title="Adding to the Collection"></a><a href="#adding-to-the-collection"></a>Adding to the Collection</h2><p>下面我们清空缓存刷新页面，我们什么变化也没有看到。但是，如果我们用 Chrome 的 debugger 工具查看 <code>Sources</code> tab ，我们会发现 Magento 已经加载了 <code>collection.js</code> (<code>Magento_Ui/js/lib/core/collectio</code>) <img src="/hellomagento2/wp-content/uploads/2018/06/debug-sources.png"> 通过 XHR debugging 我们还会发现 magento 已经加载了 <code>collection.html</code> Knockout.js template <img src="/hellomagento2/wp-content/uploads/2018/06/debug-xhr.png"> 我们切换到 console 中，我们会看到名为 <code>pulsestorm_simple_valid.pulsestorm_simple_valid</code> 的 view model constructor</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">&gt; reg.get(function(item)&#123;</span><br><span class="line">    console.log(item.name);</span><br><span class="line">    console.log(item);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">pulsestorm_simple_valid.pulsestorm_simple_valid</span><br><span class="line">UiClass &#123;_super: undefined, ignoreTmpls: Object, _requesetd: Object, containers: Array[0], exports: Object…&#125;</span><br></pre></td></tr></table></figure>

<p>如果你不确定这里在做什么，请参考 <a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan_magento_simplest_ui_component/">Magento 2: Simplest UI Component</a> 我们下一步要做的是加一些子组件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/ui_component/pulsestorm_simple_valid.xml</span><br><span class="line">&lt;container&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">    &lt;htmlContent name=&quot;our_first_content&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;block&quot; xsi:type=&quot;object&quot;&gt;Pulsestorm\SimpleValidUiComponent\Block\Example&lt;/argument&gt;</span><br><span class="line">    &lt;/htmlContent&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">&lt;/container&gt;</span><br></pre></td></tr></table></figure>

<p>The <code>htmlContent</code> node allows you to render the contents of a Magento block object into our <code>x-magento-init</code> script, and then have those contents rendered onto the page via Knockout.js.上面的例子我们将 render 名为 <code>Pulsestorm\SimpleValidUiComponent\Block\Example</code> 的 block 。我们来看 <code>definition.xml</code> 中是怎么定义 <code>&lt;htmlContent/&gt;</code> 的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;htmlContent class=&quot;Magento\Ui\Component\HtmlContent&quot;&gt;</span><br><span class="line">    &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">        &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;Magento_Ui/js/form/components/html&lt;/item&gt;</span><br><span class="line">        &lt;/item&gt;</span><br><span class="line">    &lt;/argument&gt;</span><br><span class="line">&lt;/htmlContent&gt;</span><br></pre></td></tr></table></figure>

<p>我们发现 rendering 是通过 <code>Magento_Ui/js/form/components/html</code> 模块进行的。完整地说，<code>Magento_Ui/js/form/components/html</code> 模块返回一个 Knockout.js view model constructor ，它有一个 Knockout.js “Magento remote” 模板 <code>ui/content/content</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//File: vendor/magento/module-ui/view/base/web/js/form/components/html.js</span><br><span class="line">//...</span><br><span class="line">return Component.extend(&#123;</span><br><span class="line">    defaults: &#123;</span><br><span class="line">        content:        &#x27;&#x27;,</span><br><span class="line">        showSpinner:    false,</span><br><span class="line">        loading:        false,</span><br><span class="line">        visible:        true,</span><br><span class="line">        template:       &#x27;ui/content/content&#x27;,</span><br><span class="line">        additionalClasses: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">//...</span><br></pre></td></tr></table></figure>

<p>render 的实现细节作为高级练习六个读者。 下面我们清空缓存刷新页面，然后我们就会看到下面的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception #0 (ReflectionException): Class Pulsestorm\SimpleValidUiComponent\Block\Example does not exist</span><br></pre></td></tr></table></figure>

<p>哈，我们忘记创建这个对象了 <code>Pulsestorm\SimpleValidUiComponent\Block\Example</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/Block/Example.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleValidUiComponent\Block;</span><br><span class="line"></span><br><span class="line">use Magento\Framework\View\Element\BlockInterface;</span><br><span class="line"></span><br><span class="line">class Example extends \Magento\Framework\View\Element\AbstractBlock</span><br><span class="line">&#123;</span><br><span class="line">    public function toHtml()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#x27;&lt;h1&gt;Hello PHP Block Rendered in JS&lt;/h1&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它就是 Magento 的标准 block 类，是可以通过 layout 配置的，它必须继承 <code>Magento\Framework\View\Element\AbstractBlock</code> 类。通常这些是 <code>phtml</code> template block ，但是这里为了简化我们用了 <code>toHtml</code> 方法直接返回了。 刷新页面，我们应该看到下面的样子： <img src="/hellomagento2/wp-content/uploads/2018/06/html-content.png"></p>
<h2 id="Hijacking-htmlContent-劫持-htmlContent"><a href="#Hijacking-htmlContent-劫持-htmlContent" class="headerlink" title="Hijacking htmlContent(劫持 htmlContent)"></a><a href="#hijacking-htmlcontent(%E5%8A%AB%E6%8C%81-htmlcontent)"></a>Hijacking htmlContent(劫持 htmlContent)</h2><p><code>htmlContent</code> 节点很有意思，if only for their amusing “render some server side code that renders some front-end code that renders some more server side code” pattern, we’re not interested in them today for their core functionality.我们使用 <code>htmlContent</code> 节点是因为：</p>
<ol>
<li>XSD 允许它作为 <code>&lt;container&gt;</code> 节点的子节点</li>
<li>它的基本功能相对简单</li>
<li>它是通用的，不太可能是特定功能的片段（比如 <code>&lt;listingToolbar/&gt;</code>）</li>
</ol>
<p>这些特点使得它是很适合劫持的。劫持，这里的意思是我们将利用 UI Component 的 xml 合并，使得我们的 <code>htmlContent</code> blocks 可以做如下事情：</p>
<ol>
<li>使用不同的 component class</li>
<li>使用不同的 RequireJS view model constructor factory</li>
<li>使得上面的 RequireJS view model constructor factory 指向一个新的 Knockout.js template</li>
</ol>
<p>对于第一点，我们要做的只是在 <code>htmlContent</code> XML 节点上加上新的 class 属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/ui_component/pulsestorm_simple_valid.xml</span><br><span class="line">&lt;htmlContent class=&quot;Pulsestorm\SimpleValidUiComponent\Component\Simple&quot; name=&quot;our_first_content&quot;&gt;</span><br><span class="line">&lt;/htmlContent&gt;</span><br></pre></td></tr></table></figure>

<p>我们也移除了 block argument 。因为 <code>Magento\Ui\Component\HtmlContent</code> 必须要 block argument ，但是我们的 <code>Pulsestorm\SimpleValidUiComponent\Component\Simple</code> 代替了它。 下面创建 <code>Pulsestorm\SimpleValidUiComponent\Component\Simple</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/Component/Simple.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleValidUiComponent\Component;</span><br><span class="line">class Simple extends \Magento\Ui\Component\AbstractComponent</span><br><span class="line">&#123;</span><br><span class="line">    const NAME = &#x27;html_content_pulsestorm_simple&#x27;;</span><br><span class="line">    public function getComponentName()</span><br><span class="line">    &#123;</span><br><span class="line">        return self::getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于第二点使用不同的 RequireJS view model constructor factory 我们要这样做：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;htmlContent class=&quot;Pulsestorm\SimpleValidUiComponent\Component\Simple&quot;  name=&quot;our_first_content&quot;&gt;</span><br><span class="line">    &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">        &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm_SimpleValidUiComponent/js/pulsestorm_simple_component&lt;/item&gt;</span><br><span class="line">        &lt;/item&gt;</span><br><span class="line">    &lt;/argument&gt;</span><br><span class="line">&lt;/htmlContent&gt;</span><br></pre></td></tr></table></figure>

<p>对于第三点使得 RequireJS view model constructor factory 指向一个新的 Knockout.js template</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleValidUiComponent/view/adminhtml/web/js/pulsestorm_simple_component.js</span><br><span class="line">define([&#x27;uiElement&#x27;,&#x27;ko&#x27;], function(Element, ko)&#123;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;</span><br><span class="line">        defaults: &#123;</span><br><span class="line">            template: &#x27;Pulsestorm_SimpleValidUiComponent/pulsestorm_simple_template&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return viewModelConstructor;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下面创建 <code>Pulsestorm_SimpleValidUiComponent/pulsestorm_simple_template</code> 模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleValidUiComponent//view/adminhtml/web/template/pulsestorm_simple_template.html --&gt;</span><br><span class="line">&lt;h1&gt;Our Remote Knockout Template!&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>下面清空缓存，刷新页面 <img src="/hellomagento2/wp-content/uploads/2018/06/hijack.png"> 恭喜你，我们没有违反 Magento 的 XSD schema 验证，成功创建了一个 UI Component</p>
<h2 id="Wrap-Up"><a href="#Wrap-Up" class="headerlink" title="Wrap Up"></a><a href="#wrap-up"></a>Wrap Up</h2><p>这是不是个好主意，有待后续验证。反正这次每个步骤都在我们的掌控中（自定义的 PHP Component ，自定义的 ReuqireJS Component，自定义的 Knockout.js 模板）理论上来说，将来 Magento 核心团队可能会做些修改，到时候我们今天的方法就没有用了。现在，UI Component 的基本问题是，很多证据都表明 UI Component 是 Magento 核心团队专用的，只有时间能告诉我们，第三方开发者是否能够将 UI Component 稳定地用在插件中。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/alan-magento-2-simplest-ui-knockout-component/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/alan-magento-2-simplest-ui-knockout-component/" class="post-title-link" itemprop="url">Magento 2: Simplest UI Knockout Component</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-25 17:26:04" itemprop="dateCreated datePublished" datetime="2018-05-25T17:26:04+08:00">2018-05-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/alan-storm/" itemprop="url" rel="index"><span itemprop="name">alan storm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在上篇文章中，我们通过 <code>&lt;preference&gt;</code> 的方式创建了一个最简单的 Magento 2 UI Component。如果你阅读完了整篇内容，我打赌你会对没有介绍 javascript 感到失望。今天我们将弥补上次的缺憾。 像之前一样，确保系统运行在 developer 模式，还有我们是在 Magento 2.1.1 上做的实验，不过其中涉及到的概念是所有版本都通用的。强烈建议在阅读本文前先阅读<a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan_magento_simplest_ui_component/">上篇文章</a>，不过如果你想直接开动的话，我们在 GitHub 上放了<a target="_blank" rel="noopener" href="https://github.com/astorm/magento2-simple-ui-component/">上篇的源代码</a>。</p>
<h2 id="An-App-for-Knockout-js-View-Models"><a href="#An-App-for-Knockout-js-View-Models" class="headerlink" title="An App for Knockout.js View Models"></a><a href="#an-app-for-knockout.js-view-models"></a>An App for Knockout.js View Models</h2><p>Alan 的 <a target="_blank" rel="noopener" href="https://alanstorm.com/category/magento-2/#magento_2_mvc">Magento 2 for PHP MVC Developers</a>系列文章的第二篇 Magento 2: Serving Frontend Files 讲解了 Magento 2 中是如何使用前端文件的。在 <a target="_blank" rel="noopener" href="https://alanstorm.com/category/magento-2/#magento2_advanced_javascript">Magento 2: Advanced Javascript</a>系列中讲到了 <code>x-magento-init</code> 和 Magento 2 中 Knockoug.js 实现的基础知识。2016 年 7 月份我们提到了 Magento 2 的 Knockout.js 的 template 中一些奇怪的标签（<a target="_blank" rel="noopener" href="https://alanstorm.com/magentos-knockoutjs-templates-arent-knockoutjs/">Magento’s KnockoutJS Templates aren’t KnockoutJS Templates</a>）。如果你没有阅读过前面的系列文章，那么光看刚刚的这篇，你也能获益颇多。不过如果你理不清的话，这些文章可能会给你帮助。 在上篇文章结束后，我们有了一个 <code>Pulsestorm_SimpleUiComponent</code>模块。查看源代码，看到的类似下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/x-magento-init&quot;&gt;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;*&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Magento_Ui/js/core/app&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;types&quot;:</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;dataSource&quot;: [],</span><br><span class="line">                &quot;pulsestorm_simple&quot;:</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;extends&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;html_content&quot;:</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;component&quot;: &quot;Magento_Ui\/js\/form\/components\/html&quot;,</span><br><span class="line">                    &quot;extends&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;components&quot;:</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;pulsestorm_simple&quot;:</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;children&quot;:</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;pulsestorm_simple&quot;:</span><br><span class="line">                        &#123;</span><br><span class="line">                            &quot;type&quot;: &quot;pulsestorm_simple&quot;,</span><br><span class="line">                            &quot;name&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;pulsestorm_simple_data_source&quot;:</span><br><span class="line">                        &#123;</span><br><span class="line">                            &quot;type&quot;: &quot;dataSource&quot;,</span><br><span class="line">                            &quot;name&quot;: &quot;pulsestorm_simple_data_source&quot;,</span><br><span class="line">                            &quot;dataScope&quot;: &quot;pulsestorm_simple&quot;,</span><br><span class="line">                            &quot;config&quot;:</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;data&quot;: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    &quot;foo&quot;: &quot;baz&quot;</span><br><span class="line">                                &#125;],</span><br><span class="line">                                &quot;params&quot;:</span><br><span class="line">                                &#123;</span><br><span class="line">                                    &quot;namespace&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>x-magento-init</code> 将会把这个 JSON 对象传递给 <code>Magento_Ui/js/core/app</code> 模块。我们来看看这个模块的源代码。（<a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan-magento-2-and-requirejs/">Magento 2 and RequireJS (翻译)</a>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Copyright © Magento, Inc. All rights reserved.</span><br><span class="line"> * See COPYING.txt for license details.</span><br><span class="line"> */</span><br><span class="line">define([</span><br><span class="line">    &#x27;./renderer/types&#x27;,</span><br><span class="line">    &#x27;./renderer/layout&#x27;,</span><br><span class="line">    &#x27;../lib/knockout/bootstrap&#x27;</span><br><span class="line">], function (types, layout) &#123;</span><br><span class="line">    &#x27;use strict&#x27;;</span><br><span class="line"></span><br><span class="line">    return function (data, merge) &#123;</span><br><span class="line">        types.set(data.types);</span><br><span class="line">        layout(data.components, undefined, true, merge);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这个看似简单的程序实际上是 Magento 的 UI 组件系统中最重要的 javascript 文件之一。这里的代码（准确地说是 <code>Magento_Ui/js/core/renderer/types</code> 和 <code>Magento_Ui/js/core/renderer/layout</code> 模块中的代码）负责创建和注册所有的 Knockout.js 的 view model 构造函数。 <code>view model</code> 的概念如果不是很熟悉的话，可以参考 <a target="_blank" rel="noopener" href="http://knockoutjs.com/">Knockout.js 的官方 tutorials</a> 以及 Alan 的 <a target="_blank" rel="noopener" href="https://alanstorm.com/category/magento-2/#magento2_advanced_javascript">Magento 2: Advanced Javascript</a> <code>view model</code> 构造函数的注册是我们不太熟悉的概念。本篇文章中，我们不会完整地介绍这个概念，我们现在只要知道 <code>Magento_Ui/js/core/app</code> 运行后，Magento 将向全局注册表（global registry）中加入许多 view model 的构造对象。 要理解这点，最快的办法是找个 grid 页面我们来看下 registry 是个啥。<code>Products &gt; Catalog</code> 到产品列表页，然后打开 debug 工具（chrome 中在 <code>View -&gt; Developer -&gt; Javascript Console</code>）</p>
<h2 id="The-uiRegistry"><a href="#The-uiRegistry" class="headerlink" title="The uiRegistry"></a><a href="#the-uiregistry"></a>The uiRegistry</h2><p>Magento 将所有的 Knockout.js 的 view model constructor 注册到 <code>uiRegistry</code> 模块返回的对象中。我对 javascript 的AMD 规范没有深入了解，所以我不确定这种注册到全局的做法是不是最佳实践，不过既然 Magento 这么做了，那么我们最好接受这点，然后继续我们的教程。 在 RequireJS map 中，<code>uiRegistry</code> 是一个 key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// File: vendor/magento/module-ui/view/base/requirejs-config.js</span><br><span class="line">var config = &#123;</span><br><span class="line">    paths: &#123;</span><br><span class="line">        &#x27;ui/template&#x27;: &#x27;Magento_Ui/templates&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    map: &#123;</span><br><span class="line">        &#x27;*&#x27;: &#123;</span><br><span class="line">            uiElement:      &#x27;Magento_Ui/js/lib/core/element/element&#x27;,</span><br><span class="line">            uiCollection:   &#x27;Magento_Ui/js/lib/core/collection&#x27;,</span><br><span class="line">            uiComponent:    &#x27;Magento_Ui/js/lib/core/collection&#x27;,</span><br><span class="line">            uiClass:        &#x27;Magento_Ui/js/lib/core/class&#x27;,</span><br><span class="line">            uiEvents:       &#x27;Magento_Ui/js/lib/core/events&#x27;,</span><br><span class="line">            uiRegistry:     &#x27;Magento_Ui/js/lib/registry/registry&#x27;,</span><br><span class="line">            uiLayout:       &#x27;Magento_Ui/js/core/renderer/layout&#x27;,</span><br><span class="line">            buttonAdapter:  &#x27;Magento_Ui/js/form/button-adapter&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>uiRegistry</code> 对应的模块是 <code>Magento_Ui/js/lib/registry/registry</code>，实际位置在 <code>vendor/magento/module-ui/view/base/web/js/lib/registry/registry.js</code> 。这个 registry 对象类似于字典或 hash map。你可以通过 registry 的 set 方法设置一个值，使用 get 方法去取得值。让我们来实验下。在浏览器的 debugger 中加载 <code>uiRegistry</code> 模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">Registry &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在 debugger 中看不到 uiRegistry 中的属性值。Magento 核心团队让它的属性是司有的。只能通过 <code>get</code> 方法来取得已注册的值。让我们来实验下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg.get(&#x27;product_listing.product_listing&#x27;);</span><br><span class="line">UiClass &#123;_super: undefined, ignoreTmpls: Object, _requesetd: Object,</span><br><span class="line">    containers: Array[0], exports: Object…&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们取得了一个名为 <code>product_listing.product_listing</code> 的 Knockout.js view model 。 <code>uiRegistry</code> 和普通的字典或 hash map 不同的地方在于 <code>get</code> 方法是支持查询语法的。你可以在他的定义文件 <code>vendor/magento/module-ui/view/base/web/js/lib/registry/registry.js</code> 中看到该查询语言的简要说明。我们将跳过这里，你只要知道他支持回调，这样我们可以取得 registry 中的所有对象。下面试一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg.get(function(item)&#123;</span><br><span class="line">    console.log(item.name);</span><br><span class="line">    console.log(item);</span><br><span class="line">&#125;);</span><br><span class="line">//long list of view model constructor and names snipped</span><br></pre></td></tr></table></figure>

<p>回调查询让我们可以变相地查看司有属性，一窥注册地所有 view models</p>
<h2 id="Configuring-a-View-Model-Constructor"><a href="#Configuring-a-View-Model-Constructor" class="headerlink" title="Configuring a View Model Constructor"></a><a href="#configuring-a-view-model-constructor"></a>Configuring a View Model Constructor</h2><p>产品列表页包含了大量地 view models ，不过我们还是回到较简单的 model 中吧。进入 <code>System -&gt; Other Settings -&gt; Hello Simple UI Component</code> 然后再次尝试下面的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">reg.get(function(item)&#123;</span><br><span class="line">    console.log(item.name);</span><br><span class="line">    console.log(item);</span><br><span class="line">&#125;);</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<p>我们啥也没拿到。UI Component system 并没有自动地创建 view models 。我们需要通过一个 RequireJS module 来配置我们的 UI component ，让该 RequireJS module 返回一个 view model constructor 。 首先，我们在 <code>definition.xml</code> 中加入配置节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml</span><br><span class="line">&lt;components xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_definition.xsd&quot;&gt;</span><br><span class="line">    &lt;pulsestorm_simple class=&quot;Pulsestorm\SimpleUiComponent\Component\Simple&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;!-- ... --&gt;</span><br><span class="line">            &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component&lt;/item&gt;</span><br><span class="line">            &lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/pulsestorm_simple&gt;</span><br><span class="line">&lt;/components&gt;</span><br></pre></td></tr></table></figure>

<p>清空缓存后重新载入页面，然后我们查看源代码，会看到下面这样的 JSON</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;components&quot;: &#123;</span><br><span class="line">    &quot;pulsestorm_simple&quot;: &#123;</span><br><span class="line">        &quot;children&quot;: &#123;</span><br><span class="line">            &quot;pulsestorm_simple&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;pulsestorm_simple&quot;,</span><br><span class="line">                &quot;name&quot;: &quot;pulsestorm_simple&quot;,</span><br><span class="line">                &quot;config&quot;: &#123;</span><br><span class="line">                    &quot;component&quot;: &quot;Pulsestorm_SimpleUiComponent\/js\/pulsestorm_simple_component&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">//...</span><br></pre></td></tr></table></figure>

<p>下面我们创建下面的文件，清空缓存后刷新页面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/web/js/pulsestorm_simple_component.js</span><br><span class="line">define([], function()&#123;</span><br><span class="line">    console.log(&quot;Called&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后我们会在 console 中看到如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Called</span><br><span class="line">Uncaught TypeError: Constr is not a constructor</span><br></pre></td></tr></table></figure>

<p>有进展哦。<code>Called</code> 表明我们的模块被加载了。但是我们的模块没有返回一个 view model constructor 。下面我们来修复他。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/web/js/pulsestorm_simple_component.js</span><br><span class="line">define([&#x27;uiElement&#x27;], function(Element)&#123;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;</span><br><span class="line">        defaults: &#123;</span><br><span class="line">            template: &#x27;Pulsestorm_SimpleUiComponent/pulsestorm_simple_template&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return viewModelConstructor;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里我们导入 <code>uiElement</code> 模块，用它的 <code>extend</code> 方法创建一个新的对象，这个对象就是我们的 view model constructor ，然后我们返回这个对象。 <code>uiElement</code> 模块（<code>Magento_Ui/js/lib/core/element/element</code>）是为 UI Component 系统建造的自定义类的一部分。本文不能展开来讲了，不过他是基于 underscore JS 的，如果你好奇的话，可以看这里 <a target="_blank" rel="noopener" href="https://alanstorm.com/magento-2s-base-javascript-class/">Magento 2’s Base Javascript Class</a> 上面 <code>defaults</code> 对象的 <code>template</code> 属性定义了我们的 view model 要用的 remote template （<a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan_magento_2_knockoutjs_integration/">Magento 2: KnockoutJS Integration</a>）</p>
<h2 id="Hooking-up-the-View-Model"><a href="#Hooking-up-the-View-Model" class="headerlink" title="Hooking up the View Model"></a><a href="#hooking-up-the-view-model"></a>Hooking up the View Model</h2><p>下面咱们清空缓存刷新页面后，在浏览器 debugger 中输入下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">//hold your questions on pulsestorm_simple.pulsestorm_simple</span><br><span class="line">//we&#x27;ll get there in a second</span><br><span class="line">viewModelConstructor = reg.get(&#x27;pulsestorm_simple.pulsestorm_simple&#x27;)</span><br></pre></td></tr></table></figure>

<p>然后我们会看到一条返回的 veiw model</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UiClass &#123;_super: undefined, ignoreTmpls: Object, _requesetd: Object, containers: Array[0], exports: Object…&#125;</span><br></pre></td></tr></table></figure>

<p>下一步我们将把这个 view model 和我们的 HTML 页面的 DOM 节点联系起来。这里 Magento 自定义的 Knockout.js <code>scope</code> 绑定就要隆重登场了。修改你的 UI Component 的 XHTML 模板像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/templates/different.xhtml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Hello Brave New World&lt;/h1&gt;</span><br><span class="line">    &lt;div data-bind=&quot;scope: &#x27;pulsestorm_simple.pulsestorm_simple&#x27;&quot; class=&quot;entry-edit form-inline&quot;&gt;</span><br><span class="line">        &lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们做了两件事情。第一件，我们加了 <code>data-bind=&quot;scope: &#39;pulsestorm_simple.pulsestorm_simple&#39;&quot;</code> 这个属性，这个属性会调用 Magento Knockout.js <code>scope</code> 绑定。<code>scope</code> 绑定需要一个参数 （<code>pulsestorm_simple.pulsestorm_simple</code>）。Magento 会用这个参数去查找 uiRegistry 中的 view model ，然后使得这个 view model 成为所有内部节点的当前 Knockout.js veiw model。<code>scope</code> 数据绑定允许你在同一个页面的不同部分使用不同的 Knockout.js view model 第二件事情是我们放了一个类似于 Knockout.js 绑定标签的东东：<code>&lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;</code>这个东东将加载当前 view model 的 template 。<code>getTemplate</code> 方法来自于我们继承的类 <code>uiElement</code> 下面清空缓存并刷新页面，我们将看到下面的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unable to resolve the source file for ‘adminhtml/Magento/backend/enUS/PulsestormSimpleUiComponent/template/pulsestormsimpletemplate.html’ #0 /path/to/magento/vendor/magento/framework/App/StaticResource.php(97): Magento\Framework\View\Asset\File-&gt;getSourceFile() #1 /path/to/magento/vendor/magento/framework/App/Bootstrap.php(258): Magento\Framework\App\StaticResource-&gt;launch() #2 /path/to/magento/pub/static.php(13): Magento\Framework\App\Bootstrap-&gt;run(Object(Magento\Framework\App\StaticResource)) #3 &#123;main&#125;</span><br></pre></td></tr></table></figure>

<p>因为我们刚刚配置了 template 但却没有创建他呀。下面咱们创建一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/web/template/pulsestorm_simple_template.html --&gt;</span><br><span class="line">&lt;h1&gt;Rendered with Knockout.js&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>然后清空缓存刷新页面，你应该看到下面这样的： <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-ko-component-1.png"> 恭喜你，你刚刚创建了一个基于 Knockout.js 的 Magento UI Component.</p>
<h2 id="Using-Knockout"><a href="#Using-Knockout" class="headerlink" title="Using Knockout"></a><a href="#using-knockout"></a>Using Knockout</h2><p>当然了，花这么大力气就为了加载一个静态 HTML 也太小题大做了。要充分利用 Knockout.js 的优势，你需要在 RequireJS 模块中导入它。 举例说来，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/web/template/pulsestorm_simple_template.html --&gt;</span><br><span class="line">&lt;h1&gt;Rendered with Knockout.js&lt;/h1&gt;</span><br><span class="line">&lt;strong data-bind=&quot;text: message&quot;&gt;&lt;/strong&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//File: vendor/magento//module-ui/view/base/web/js/core/app.js</span><br><span class="line">define([&#x27;uiElement&#x27;,&#x27;ko&#x27;], function(Element, ko)&#123;</span><br><span class="line">    viewModelConstructor = Element.extend(&#123;</span><br><span class="line">        defaults: &#123;</span><br><span class="line">            template: &#x27;Pulsestorm_SimpleUiComponent/pulsestorm_simple_template&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        message: ko.observable(&quot;Hello Knockout.js!&quot;)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return viewModelConstructor;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里，我们导入了 <code>ko</code> 模块。这个 <code>ko</code> 模块就相当于 Knockout.js 提供的全局 <code>ko</code> （<a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan_magento_2_knockoutjs_integration/">Magento 2 KnockoutJS 集成</a>）。我们还加了一个 <code>message</code> 属性，把这个属性设成 <code>ko.observable</code> 对象。这个就是 Knockout.js 的用法。然后刷新页面，你应该看到： <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-ko-component-2.png"> 下面在浏览器 debugger 中，输入下面的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">&gt; reg.get(&#x27;pulsestorm_simple.pulsestorm_simple&#x27;).message(&quot;Change Me&quot;);</span><br></pre></td></tr></table></figure>

<p>然后立刻，我们的页面变成下面这样了： <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-ko-component-3.png"></p>
<h2 id="Modern-Javascript-and-the-Browser-Debugger"><a href="#Modern-Javascript-and-the-Browser-Debugger" class="headerlink" title="Modern Javascript and the Browser Debugger"></a><a href="#modern-javascript-and-the-browser-debugger"></a>Modern Javascript and the Browser Debugger</h2><p>Magento 2 javascript（以及许多其他现代 javascript）调试的挑战之一就是跟踪哪些加载了哪些没有。再也不像以前那样，查看源代码查找 <code>&lt;script&gt;</code> 标签。 Google Chrome 的 debugger ，如果你要查找 RequireJS 的模块。那么可以去 <code>Source</code> tab <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-ko-component-4.png"> 如果你要看 Knockout.js 的 remote template ，<code>Network -&gt; XHR</code> 正是你要找的。 <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-ko-component-5.png"> 需要特别注意浏览器中使用的文件是不是最新的。Magento 有自己的缓存机制，还有 Magento 对前端文件设置了一些强势的 header （<a target="_blank" rel="noopener" href="https://alanstorm.com/magento-2-frontend-files-serving/">Magento 2: Serving Frontend Files</a>）所以除了清空 Magento 缓存，有时候也有必要清理浏览器的缓存。</p>
<h2 id="Why-the-Double-Name"><a href="#Why-the-Double-Name" class="headerlink" title="Why the Double Name"></a><a href="#why-the-double-name"></a>Why the Double Name</h2><p>view model constructor 重复的名称可能会让你觉得困惑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">product_listing.product_listing</span><br><span class="line">pulsestorm_simple.pulsestorm_simple</span><br></pre></td></tr></table></figure>

<p>名称来自于 <code>/ui_component/*.xml</code> 文件名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/pulsestorm_simple.xml --&gt;</span><br><span class="line">&lt;uiComponent name=&quot;pulsestorm_simple&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>但是，通过上面的例子，我们依然不清楚为什么要用两次名称，这种格式意味着某种层次。这正是 UI Component 系统的特性，通过他我们将理解 Magento 自带的 listing 和 form components 是怎么回事。 首先，回到 <code>definition.xml</code> 文件，修改成下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml</span><br><span class="line">&lt;components xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_definition.xsd&quot;&gt;</span><br><span class="line">    &lt;pulsestorm_simple class=&quot;Pulsestorm\SimpleUiComponent\Component\Simple&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                &lt;!-- &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component&lt;/item&gt; --&gt;</span><br><span class="line">                &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;uiComponent&lt;/item&gt;</span><br><span class="line">            &lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/pulsestorm_simple&gt;</span><br><span class="line">&lt;/components&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们将 <code>Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component</code> 替换成了 <code>uiComponent</code> ，这个模块就是 <code>Magento_Ui/js/lib/core/collection</code> 下面我们清除缓存刷新页面，这次我们的模板不会被加载咯。这说明，不同的 view model 不同的模板。 下面在浏览器 debugger 中输入下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">&gt; viewModelConstructor = reg.get(&#x27;pulsestorm_simple.pulsestorm_simple&#x27;)</span><br><span class="line">&gt; viewModelConstructor.getTemplate()</span><br><span class="line">ui/collection</span><br></pre></td></tr></table></figure>

<p>这个 <code>ui/collection</code> 对应的就是下面这个文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: vendor/magento//module-ui/view/base/web/templates/collection.html --&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">/**</span><br><span class="line"> * Copyright © 2016 Magento. All rights reserved.</span><br><span class="line"> * See COPYING.txt for license details.</span><br><span class="line"> */</span><br><span class="line">--&gt;</span><br><span class="line">&lt;each args=&quot;data: elems, as: &#x27;element&#x27;&quot;&gt;</span><br><span class="line">    &lt;render if=&quot;hasTemplate()&quot;/&gt;</span><br><span class="line">&lt;/each&gt;</span><br></pre></td></tr></table></figure>

<p>如果你对 Magento 2 的前端代码不熟悉，那么肯定会对这些标签感到困惑。这些标签是 Magento 2 扩展了 Knockout.js rendering engine 后的结果（<a target="_blank" rel="noopener" href="https://alanstorm.com/magentos-knockoutjs-templates-arent-knockoutjs/">Magento’s KnockoutJS Templates aren’t KnockoutJS Templates</a>）。用 Knockout.js 的写法，就是下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- ko foreach: &#123;data: elems, as: &#x27;element&#x27;&#125; --&gt;</span><br><span class="line">    &lt;!-- ko if: hasTemplate() --&gt;&lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;&lt;!-- /ko --&gt;</span><br><span class="line">&lt;!-- /ko --&gt;</span><br></pre></td></tr></table></figure>

<p>然后在浏览器中输入下面的代码，我们看看 <code>elems</code> 是什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">&gt; viewModelConstructor = reg.get(&#x27;pulsestorm_simple.pulsestorm_simple&#x27;)</span><br><span class="line">&gt; viewModelConstructor.elems()</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<p>是个空数组。那么我们怎么往里面加东西呢？通过 UI Component 配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/pulsestorm_simple.xml --&gt;</span><br><span class="line">&lt;pulsestorm_simple xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;!--  ... --&gt;</span><br><span class="line">    &lt;htmlContent name=&quot;first_ever_child&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;block&quot; xsi:type=&quot;object&quot;&gt;Magento\Framework\View\Element\Text&lt;/argument&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component&lt;/item&gt;</span><br><span class="line">            &lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/htmlContent&gt;</span><br><span class="line">&lt;/pulsestorm_simple&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们给 <code>pulsestorm_simple.xml</code> 加了一个 <code>&lt;htmlContent/&gt;</code> 子节点。这个 <code>&lt;htmlContent/&gt;</code> 是 Magento 提供的，不过这不重要，重要的是我们给这个节点配置了 <code>Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component</code> 组件。 清空缓存然后刷新页面，你又看到 <code>Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component</code> 组件加载的模板了。 <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-ko-component-2.png"> 有意思的是 <code>uiRegistry</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">&gt; reg.get(function(item)&#123;</span><br><span class="line">    console.log(item.name);</span><br><span class="line">&#125;)</span><br><span class="line">undefined</span><br><span class="line">pulsestorm_simple.pulsestorm_simple</span><br><span class="line">pulsestorm_simple.pulsestorm_simple.first_ever_child</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<p>这里我们看到了组件定义的层次结构。下面我们再到 UI Component XML 中加上另一个节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/pulsestorm_simple.xml --&gt;</span><br><span class="line">&lt;pulsestorm_simple xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;!--  ... --&gt;</span><br><span class="line">    &lt;htmlContent name=&quot;first_ever_child&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;block&quot; xsi:type=&quot;object&quot;&gt;Magento\Framework\View\Element\Text&lt;/argument&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component&lt;/item&gt;</span><br><span class="line">            &lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/htmlContent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;htmlContent name=&quot;second_ever_child&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;block&quot; xsi:type=&quot;object&quot;&gt;Magento\Framework\View\Element\Text&lt;/argument&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm_SimpleUiComponent/js/pulsestorm_simple_component&lt;/item&gt;</span><br><span class="line">            &lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/htmlContent&gt;</span><br><span class="line">&lt;/pulsestorm_simple&gt;</span><br></pre></td></tr></table></figure>

<p>然后清空缓存刷新页面，我们会看到那个模板被加载了两次。 <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-ko-component-6.png"> 然后咱们到浏览器 debugger 中看下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; reg = requirejs(&#x27;uiRegistry&#x27;);</span><br><span class="line">&gt; reg.get(function(item)&#123;</span><br><span class="line">    console.log(item.name);</span><br><span class="line">&#125;)</span><br><span class="line">pulsestorm_simple.pulsestorm_simple</span><br><span class="line">pulsestorm_simple.pulsestorm_simple.first_ever_child</span><br><span class="line">pulsestorm_simple.pulsestorm_simple.second_ever_child</span><br></pre></td></tr></table></figure>

<p>你有很多方法可以用 UI Component system 去完成前端代码，不过最终 Magento 2 中的主要用法就是这样的。<code>uiComponent/Magento_Ui/js/lib/core/collection</code> 模块 <strong>collects and renders a series of Knockout.js view models</strong> 顶层的 UI Component 负责加载 XHTML 模板，但是如果他的 configuration 中设置了 <code>uiComponent</code> 的属性，并且他的 XHTML 中通过 <code>scope</code> 绑定调用该模块，那么他的子节点会被命名成这种树形的结构。 这一点有点难理解，的 configuration 中设置了 <code>uiComponent</code> 的属性，指的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml</span><br><span class="line">&lt;components xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_definition.xsd&quot;&gt;</span><br><span class="line">    &lt;pulsestorm_simple class=&quot;Pulsestorm\SimpleUiComponent\Component\Simple&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;config&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                &lt;!-- uiComponent 属性 --&gt;</span><br><span class="line">                &lt;item name=&quot;component&quot; xsi:type=&quot;string&quot;&gt;uiComponent&lt;/item&gt;</span><br><span class="line">            &lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/pulsestorm_simple&gt;</span><br><span class="line">&lt;/components&gt;</span><br></pre></td></tr></table></figure>

<p>XHTML 中通过 <code>scope</code> 绑定调用该模块,指的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/templates/different.xhtml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Hello Brave New World&lt;/h1&gt;</span><br><span class="line">    &lt;div data-bind=&quot;scope: &#x27;pulsestorm_simple.pulsestorm_simple&#x27;&quot; class=&quot;entry-edit form-inline&quot;&gt;</span><br><span class="line">        &lt;!-- ko template: getTemplate() --&gt;&lt;!-- /ko --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>子节点会被命名成树形结构，指的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pulsestorm_simple.pulsestorm_simple</span><br><span class="line">pulsestorm_simple.pulsestorm_simple.first_ever_child</span><br><span class="line">pulsestorm_simple.pulsestorm_simple.second_ever_child</span><br></pre></td></tr></table></figure>

<p>让人困惑的是，根节点也被注册成一个 view model constructor 了，这就是 <code>pulsestorm_simple.pulsestorm_simple</code> 的由来。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><a href="#%E6%80%BB%E7%BB%93"></a>总结</h2><p>经过这么一番捣鼓，你现在应该更深入了解 Magento 2 的神秘新系统 UI Component 了。不过，还有很多等着我们去探索。再下一篇文章中，我们将更深入地挖掘一下，看看 UI Components 怎么获得 <code>&lt;dataProvider&gt;</code> 中地数据，然后修订我们这次地模块，看看能不能不用 <code>&lt;preference/&gt;</code> 使用这个系统。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/alan-magento-simplest-ui-component/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/alan-magento-simplest-ui-component/" class="post-title-link" itemprop="url">Magento 2: Simplest UI Component</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-21 17:04:51" itemprop="dateCreated datePublished" datetime="2018-05-21T17:04:51+08:00">2018-05-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/alan-storm/" itemprop="url" rel="index"><span itemprop="name">alan storm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://alanstorm.com/magento_simplest_ui_component/">原文地址</a> 今天我们将深入 Magento 2 的 ui components ，并尝试从头创建一个。现阶段的 Maggento 2 创建一个 ui component ，需要用一些不同寻常的，对生产环境来说不安全的方法，但是要想真正了解一个系统，有时候就是要从“地基”开始。 和这个系列的其他教程一样，请确保 Magento 2 是 developer 模式。为了防止下面的步骤不管用，我们在 <a target="_blank" rel="noopener" href="https://github.com/astorm/magento2-simple-ui-component">github 上放了完整的模块代码</a>。还有，以下基于 Magento 2.1.1 ，但是文中涉及的概念是适用所有版本的。</p>
<h2 id="用-Pestle-创建基本的模块"><a href="#用-Pestle-创建基本的模块" class="headerlink" title="用 Pestle 创建基本的模块"></a><a href="#%E7%94%A8-pestle-%E5%88%9B%E5%BB%BA%E5%9F%BA%E6%9C%AC%E7%9A%84%E6%A8%A1%E5%9D%97"></a>用 Pestle 创建基本的模块</h2><p>首先，我们用 <a target="_blank" rel="noopener" href="https://github.com/astorm/pestle">pestle</a>来创建一个带后台 menu 的模块。如果你不清楚下面的命令在干啥，那你可能要看看 <a target="_blank" rel="noopener" href="https://alanstorm.com/category/magento-2/#magento_2_mvc">Magento 2 for PHP MVC Developers</a> 系列文章 首先取得 pestle.phar</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LO http://pestle.pulsestorm.net/pestle.phar</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">php pestle.phar generate_module Pulsestorm SimpleUiComponent 0.0.1</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_acl Pulsestorm_SimpleUiComponent Pulsestorm_SimpleUiComponent::top,Pulsestorm_SimpleUiComponent::menu_1</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_menu Pulsestorm_SimpleUiComponent Magento_Backend::system_other_settings Pulsestorm_SimpleUiComponent::a_menu_item Pulsestorm_SimpleUiComponent::menu_1 &quot;Hello Simple Ui Component&quot; pulsestorm_simpleuicomponent/index/index 1</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_route Pulsestorm_SimpleUiComponent adminhtml pulsestorm_simpleuicomponent</span><br><span class="line"></span><br><span class="line">php pestle.phar generate_view Pulsestorm_SimpleUiComponent adminhtml pulsestorm_simpleuicomponent_index_index Main content.phtml 1column</span><br><span class="line"></span><br><span class="line">php bin/magento module:enable Pulsestorm_SimpleUiComponent</span><br><span class="line"></span><br><span class="line">php bin/magento setup:upgrade</span><br></pre></td></tr></table></figure>

<p>运行上述命令后，登陆后台，应该就能通过 <strong>System -&gt; Other Settings -&gt; Hello Simple Ui Component</strong> 进入到刚刚创建的页面中了。</p>
<h2 id="配置-UI-component"><a href="#配置-UI-component" class="headerlink" title="配置 UI component"></a><a href="#%E9%85%8D%E7%BD%AE-ui-component"></a>配置 UI component</h2><p>点击 <strong>System -&gt; Other Settings -&gt; Hello Simple Ui Component</strong> 进入到刚刚创建的页面，你看到的是这样子的： <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-component-first.png" alt="simple-ui-component"> 首先我们要做的是给我们的 layout handle xml 文件加 <code>&lt;uiComponent&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/layout/pulsestorm_simpleuicomponent_index_index.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;page xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:framework:View/Layout/etc/page_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;referenceBlock name=&quot;content&quot;&gt;</span><br><span class="line">        &lt;block template=&quot;content.phtml&quot; class=&quot;Pulsestorm\SimpleUiComponent\Block\Adminhtml\Main&quot; name=&quot;pulsestorm_simpleuicomponent_block_main&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- START: our new ui component --&gt;</span><br><span class="line">        &lt;uiComponent name=&quot;pulsestorm_simple&quot;/&gt;</span><br><span class="line">        &lt;!-- END:   our new ui component --&gt;</span><br><span class="line">    &lt;/referenceBlock&gt;</span><br><span class="line">&lt;/page&gt;</span><br></pre></td></tr></table></figure>

<p>上面的代码，我们告诉 Magento 我们要加一个 <code>pulsestorm_simple</code> UI component 到页面的 content block 中。然后没咱们清空缓存，刷新页面，我们会看到如下的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1 exception(s):</span><br><span class="line">Exception #0 (Magento\Framework\Exception\LocalizedException): Object </span><br><span class="line">DOMDocument should be created.</span><br><span class="line"></span><br><span class="line">Exception #0 (Magento\Framework\Exception\LocalizedException): Object </span><br><span class="line">DOMDocument should be created.</span><br><span class="line">#0 /path/to/magento/</span><br><span class="line">vendor/magento/framework/View/Element/UiComponent/Config/Reader.php(95):</span><br><span class="line">Magento\Framework\View\Element\UiComponent\Config\DomMerger-&gt;getDom()</span><br></pre></td></tr></table></figure>

<p>错误原因是我们配置一个叫 <code>pulsestorm_simple</code> 的 ui component ，但是 Magento 又找不到它的定义文件。<code>Object DOMDocument should be created</code> 错误来自于 php 代码尝试载入一个不存在的 xml object。 任何 ui component 都需要一个 <code>ui_component/[...].xml</code> 定义文件。下面我们修复这个问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/pulsestorm_simple.xml --&gt;</span><br><span class="line">&lt;pulsestorm_simple xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">&lt;/pulsestorm_simple&gt;</span><br></pre></td></tr></table></figure>

<p>ui component 的名字（pulsestorm_simple）和它的 xml 文件名（pulsestorm_simple.xml）需要一致。所有 ui component 的文件都在 <a href="frontend/adminhtml">area</a>&#x2F;view&#x2F;ui_component 目录下。尽管不限制使用 ui component 在 <code>frontend</code> area 中，但是前台不一定会像预期的那样管用，因为 Magento 核心团队大多数情况下（只在？）后台 layout 中使用 ui components 。 清除缓存，刷新页面后，我们会得到一个新的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 exception(s):</span><br><span class="line">Exception #0 (Magento\Framework\Exception\LocalizedException): Element</span><br><span class="line">&#x27;pulsestorm_simple&#x27;: No matching global declaration available for the</span><br><span class="line">validation root.</span><br><span class="line">Line: 1</span><br></pre></td></tr></table></figure>

<p>这里，我们的顶层节点名字叫 <code>pulsestorm_simple</code> 。回顾上篇 <a target="_blank" rel="noopener" href="https://www.hellomagento2.com/alan_magento_2_introducing_ui_components/">Magento 2 的 UI Components 介绍（翻译）</a>， ui component 文件是 domain specific language (DSL)，由它控制嵌套的 php 对象的实例化。<code>ui_component</code> 文件中的每个节点对应着下面这个文件中的节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vendor/magento/module-ui/view/base/ui_component/etc/definition.xml</span><br></pre></td></tr></table></figure>

<p>所以，问题是我们的节点 <code>pulsestorm_simple</code> 不在 <code>definition.xml</code> 中，Magento 的 UI component DSL 当然也就不知道遇到这个节点的时候，用哪个 php 类去实例化。多亏了 Magento 会合并配置文件再载入，我们就可以通过添加下面的文件来改变合并后的 <code>definition.xml</code> （<strong>必须搁在 <code>base</code> 下面才管用</strong>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml --&gt;</span><br><span class="line">&lt;components xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_definition.xsd&quot;&gt;</span><br><span class="line">    &lt;pulsestorm_simple class=&quot;Pulsestorm\SimpleUiComponent\Component\Simple&quot;/&gt;</span><br><span class="line">&lt;/components&gt;</span><br></pre></td></tr></table></figure>

<p>通过上面的配置，我们等于告诉 Magento <em>遇到 <code>pulsestorm_simple</code> ui component 节点，请实例化 <code>Pulsestorm\SimpleUiComponent\Component\Simple</code></em> 命名要注意，因为我们的文件会和核心 <code>definition.xml</code> 进行合并，如果你的命名和核心中的重名了，那么可能就改变系统原来的行为了。推荐加上 vendor namespace 作为前缀（pulsestorm_ ） 清空缓存，刷新页面，我们会得到一个新的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 exception(s):</span><br><span class="line">Exception #0 (Magento\Framework\Exception\LocalizedException): Element</span><br><span class="line">&#x27;pulsestorm_simple&#x27;: This element is not expected. Expected is one of</span><br><span class="line">( range, tab, dataSource, paging, massaction, listing, form, fieldset,</span><br><span class="line">field, filters ).</span><br></pre></td></tr></table></figure>

<p>Magento 正在合并我们的 <code>definition.xml</code>，但必须通过 schema validation 。具体来说，Magento 要求最终的 <code>definition.xml</code> 要符合下面这个文件中定义结构要求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vendor/magento/module-ui/etc/ui_definition.xsd</span><br></pre></td></tr></table></figure>

<p>很不幸的是，Magento 2 没有提供方法让我们加入规则。如果你知道查看哪里（Magento\Framework\Config\Dom::validateDomDocument），可以使用 object manager 的 preference 来注入一些自定义的行为，这样我们是可以让 Magento 跳过 XSD 验证的。但是，很不幸，这么做可能跟其他也这么做的插件冲突。所以如果你打算发布代码的话，这么做可不太合适。使用 Magento 的 plugin 方式（更安全稳定些）也是不行的，因为 <code>validateDomDocument</code> 虽然是 public 但它是 static 方法，Magento 的 plugin system 不支持 static 方法。 到这里，我们想创建一个全新的、顶层的 ui_component 节点是行不通的。这预示着，Magento 的 UI component 系统是为官方核心开发保留的，也可能说是 UI component 还不是功能齐全的。</p>
<h2 id="跳过验证"><a href="#跳过验证" class="headerlink" title="跳过验证"></a><a href="#%E8%B7%B3%E8%BF%87%E9%AA%8C%E8%AF%81"></a>跳过验证</h2><p>当然咯，上面我们说行不通，是说，用安全稳定的方法做不到，但是我们还是可以通过可能不那么稳定的 class preference 来做到嘛。 Magento 的开发者通过 calss preference 定义 interfaces 对应的具体类，object manager 遇到这个 interface 的时候，就会去实例化对应的具体类。 Class preference 还可以用来替换具体的类，和 Magento 1 中 class rewrites 有非常相似的功能（缺点也是一样的）。 下面我们将用 class preference 方式来跳过 XML 的 XSD 验证。在生产环境中，或是要发布的系统中，这么做是不合适的，但是这里只是为了让教程继续下去。 创建 di.xml 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/etc/di.xml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;config xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:framework:ObjectManager/etc/config.xsd&quot;&gt;                                                                --&gt;</span><br><span class="line">    &lt;preference for=&quot;Magento\Framework\App\Arguments\ValidationState&quot; type=&quot;Pulsestorm\SimpleUiComponent\Model\ValidationState&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/config&gt;</span><br></pre></td></tr></table></figure>

<p>然后添加下面的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/Model/ValidationState.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleUiComponent\Model;</span><br><span class="line">class ValidationState extends \Magento\Framework\App\Arguments\ValidationState</span><br><span class="line">&#123;</span><br><span class="line">    public function isValidationRequired()</span><br><span class="line">    &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于为什么这么做就可以跳过 XSD 验证，本篇不介绍，有兴趣的读者可以自己研究下，不过<a target="_blank" rel="noopener" href="https://alanstorm.com/magento-2-more-plugin-edge-cases/">这篇</a>可能对你有帮助。 清理缓存后刷新页面，这次看到一个新的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 exception(s):</span><br><span class="line">Exception #0 (ReflectionException): Class</span><br><span class="line">Pulsestorm\SimpleUiComponent\Component\Simple does not exist</span><br></pre></td></tr></table></figure>

<p>XSD 验证跳过了，我们可以继续探索了。 <strong>UPDTE:</strong> Hello, from late 2017! When Magento release version 2.2, they broke this tutorial. If you’re using Magento 2.2, in addition to disabling XSD validation, you’ll also need to add a <a target="_blank" rel="noopener" href="https://github.com/astorm/magento2-simple-ui-component/blob/master/first-pass-unstable/app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.map.xml">definition.map.xml</a> file with a name&#x3D;”puslestorm_simple” node. Why? We have no idea and Magento haven’t really explained what this file is for. Open source doesn’t always mean open intent. If you’re using Magento 2.2 just copy <a target="_blank" rel="noopener" href="https://github.com/astorm/magento2-simple-ui-component/blob/master/first-pass-unstable/app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.map.xml">the file from GitHub</a> to your module and you should take take of any errors about undefined <code>children</code> keys.</p>
<h2 id="UI-Component-Rendering-Class"><a href="#UI-Component-Rendering-Class" class="headerlink" title="UI Component Rendering Class"></a><a href="#ui-component-rendering-class"></a>UI Component Rendering Class</h2><p>在我们遇到 schema validation 的坑之前，我们在 <code>definition.xml</code> 中添加了以下设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml --&gt;</span><br><span class="line">&lt;components xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_definition.xsd&quot;&gt;</span><br><span class="line">    &lt;pulsestorm_simple class=&quot;Pulsestorm\SimpleUiComponent\Component\Simple&quot;/&gt;</span><br><span class="line">&lt;/components&gt;</span><br></pre></td></tr></table></figure>

<p><code>etc/definition.xml</code> 定义了<strong>默认的</strong>属性和节点，当 Magento 在 <code>ui_component/[somefile].xml</code> 遇到特定的节点的时候，就会用 <code>definition.xml</code> 中的值。以本例来说，当 Magento 遇到 <code>pulsestorm_simple</code> 时，就会使用 <code>Pulsestorm\SimpleUiComponent\Component\Simple</code> 类。就是说，下面我们使用 <code>pulsestorm_simple</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/pulsestorm_simple.xml --&gt;</span><br><span class="line">&lt;pulsestorm_simple xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class="line">&lt;/pulsestorm_simple&gt;</span><br></pre></td></tr></table></figure>

<p>Magento 会尝试用 <code>Pulsestorm\SimpleUiComponent\Component\Simple</code> 实例化对象，用这个对象去 render UI component。所以错误就是 <code>Pulsestorm\SimpleUiComponent\Component\Simple</code> 不存在。下面创建它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/Component/Simple.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleUiComponent\Component;</span><br><span class="line">class Simple extends \Magento\Ui\Component\AbstractComponent</span><br><span class="line">&#123;</span><br><span class="line">    const NAME = &#x27;pulsestorm_simple&#x27;;</span><br><span class="line">    public function getComponentName()</span><br><span class="line">    &#123;</span><br><span class="line">        return static::NAME;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Magento 2 的 UI component 类必须继承 <code>Magento\Ui\Component\AbstractComponent</code> 类，必须定义一个 <code>getComponentName</code> 方法。ui component 的 name 是否必须和 UI component node 的 name 一样，还是要和 <code>ui_componont/[filename].xml</code> (pulsestorm_simple) 一样不太清楚。但是最好是跟 Magento 的核心代码的做法保持一致。所以，我们也给我们的 component 一个 NAME constant 。 清空缓存，刷新页面后我们得到了一个新的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 exception(s):</span><br><span class="line">Exception #0 (Magento\Framework\Exception\LocalizedException): Object</span><br><span class="line">DOMDocument should be created.</span><br><span class="line"></span><br><span class="line">Exception #0 (Magento\Framework\Exception\LocalizedException): Object</span><br><span class="line">DOMDocument should be created.</span><br></pre></td></tr></table></figure>

<p>这次 Magento 又报错说 XML 文件缺少了。ui component object （继承自 <code>Magento\Ui\Component\AbstractComponent</code>）负责 render XHML templates 。 我们告诉 Magento ，我需要 render <code>Pulsestorm\SimpleUiComponent\Component\Simple</code> 对象，但是我们没告诉它 <code>Pulsestorm\SimpleUiComponent\Component\Simple</code> 这个对象应该用哪个 template 。下面我们修改 <code>definition.xml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml --&gt;</span><br><span class="line">&lt;components xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_definition.xsd&quot;&gt;</span><br><span class="line">    &lt;pulsestorm_simple class=&quot;Pulsestorm\SimpleUiComponent\Component\Simple&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;template&quot; xsi:type=&quot;string&quot;&gt;templates/our-template&lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/pulsestorm_simple&gt;</span><br><span class="line">&lt;/components&gt;</span><br></pre></td></tr></table></figure>

<p>下面创建模板文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/templates/our-template.xhtml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Hello World&lt;/h1&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>UI component 将会在模块的 <code>view/[area]/ui_component</code> 目录下找 template。<code>definition.xml</code> 文件中的值会加上 <code>.xhtml</code> 后缀转成文件路径。请注意，虽然文件看起来很像 HTML ，但是他们是有 XML 头的。他们是 XHTML 文件，是需要格式良好的 XML 。 下面清楚缓存，刷新页面，这次我们又看到一个新的错误，不过这次已经接近目标了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">( ! ) Fatal error: Method Magento\Ui\TemplateEngine\Xhtml\Result::__toString() must not throw an</span><br><span class="line"> exception, caught Error: Call to a member function getConfigData() on null</span><br><span class="line"> in /path/to/magento/</span><br><span class="line"> vendor/magento/module-ui/Component/Wrapper/UiComponent.php on line 0</span><br></pre></td></tr></table></figure>

<p>UI components 系统除了 render XHTML templates 外，还需要将特定的 XHTML template 与 data provider class 匹配起来。UI component 设计本意是从服务端获取数据，data provider 是 component 获得数据的正式方法。 这意味着，创建一个最简单的 UI component 的最后一步就是配置一个 data provider class 。这个改动放在 <code>pulsestorm_simple.xml</code> 中，因为理论上每个 component 实例都 render 不同的 UI Component 。下面我们给 <code>pulsestorm_simple.xml</code> 添加 <code>dataSource</code> 节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/pulsestorm_simple.xml --&gt;</span><br><span class="line">&lt;pulsestorm_simple xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dataSource name=&quot;pulsestorm_simple_data_source&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;dataProvider&quot; xsi:type=&quot;configurableObject&quot;&gt;</span><br><span class="line">            &lt;!-- the PHP class that implements a data provider --&gt;</span><br><span class="line">            &lt;argument name=&quot;class&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm\SimpleUiComponent\Model\DataProvider&lt;/argument&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- redundant with the `dataSource` name --&gt;</span><br><span class="line">            &lt;argument name=&quot;name&quot; xsi:type=&quot;string&quot;&gt;pulsestorm_simple_data_source&lt;/argument&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- required: means ui components are meant to work with models --&gt;</span><br><span class="line">            &lt;argument name=&quot;primaryFieldName&quot; xsi:type=&quot;string&quot;&gt;entity_id&lt;/argument&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- required: means ui components are meant to work with URL passing --&gt;</span><br><span class="line">            &lt;argument name=&quot;requestFieldName&quot; xsi:type=&quot;string&quot;&gt;id&lt;/argument&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dataSource&gt;</span><br><span class="line"></span><br><span class="line">&lt;/pulsestorm_simple&gt;</span><br></pre></td></tr></table></figure>

<p>在 <code>&lt;dataSource/&gt;</code> 树中有一些冗余的样板命名约定需要注意。首先是 name 属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dataSource name=&quot;pulsestorm_simple_data_source&quot;&gt;...&lt;/dataSource&gt;</span><br></pre></td></tr></table></figure>

<p>它是 UI component 名称（pulsestorm_simple）加上 <code>_data_source</code>，同样的还有下面的参数节点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;argument name=&quot;name&quot; xsi:type=&quot;string&quot;&gt;pulsestorm_simple_data_source&lt;/argument&gt;</span><br></pre></td></tr></table></figure>

<p>这个参数节点是必要的，虽然它是冗余的。 下面两个节点也是必要的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;argument name=&quot;primaryFieldName&quot; xsi:type=&quot;string&quot;&gt;entity_id&lt;/argument&gt;</span><br><span class="line">&lt;argument name=&quot;requestFieldName&quot; xsi:type=&quot;string&quot;&gt;id&lt;/argument&gt;</span><br></pre></td></tr></table></figure>

<p>最后是 class</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;argument name=&quot;class&quot; xsi:type=&quot;string&quot;&gt;Pulsestorm\SimpleUiComponent\Model\DataProvider&lt;/argument&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们告诉我们的 component 使用哪个 PHP data provider class 去进行实例化。所以我们下面创建它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/Model/DataProvider.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleUiComponent\Model;</span><br><span class="line">class DataProvider extends \Magento\Ui\DataProvider\AbstractDataProvider</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataProvider 类必须继承自 <code>Magento\Ui\DataProvider\AbstractDataProvider</code> —— 尽管这个类没有 abstract methods 需要定义。 下面清空缓存，刷新页面。 <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-component-second.png"> 我们终于把 XHTML 模板给 render 出来啦。</p>
<h2 id="幕后发生的事情"><a href="#幕后发生的事情" class="headerlink" title="幕后发生的事情"></a><a href="#%E5%B9%95%E5%90%8E%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85"></a>幕后发生的事情</h2><p>在我们讨论可以用这个渲染的 XHTML 模板来做点什么事情之前，让我们先来谈谈幕后发生了什么。当 Magento 的 layout rendering code 遇到 UI component 标签的时候，一堆等同于下面的伪代码的代码就会执行。 配置 ui_component 的整个过程是选择实例化的类，并在该类上设置数据属性。在本例中实例化过程就像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$data = functionThatLoadsArgumentNodesFromXmlFiles();</span><br><span class="line">$ui_component = new Pulsestorm\SimpleUiComponent\Component\Simple(</span><br><span class="line">    //...</span><br><span class="line">    [</span><br><span class="line">        &#x27;template&#x27;=&gt;&#x27;templates/our-template&#x27;</span><br><span class="line">    ],</span><br><span class="line">);</span><br><span class="line">echo $ui_component-&gt;render();</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$data = functionThatLoadsArgumentNodesFromXmlFiles();</span><br><span class="line">$ui_component = new Pulsestorm\SimpleUiComponent\Component\Simple(</span><br><span class="line">    //...</span><br><span class="line">    $data,</span><br><span class="line">);</span><br><span class="line">echo $ui_component-&gt;render();</span><br></pre></td></tr></table></figure>

<p>好的 DSL 通常会让你忘记像这样的实现细节——但是如果你从来没有遇到过 dsl， 这种事情看起来很奇怪， 也很陌生。每当你被一些 UI 组件的配置缠住时, 请记住您正在为 Magento 准备转换为 PHP 代码的值。这些值并不是简单的数据属性。</p>
<h2 id="Raw-Template-Source"><a href="#Raw-Template-Source" class="headerlink" title="Raw Template Source"></a><a href="#raw-template-source"></a>Raw Template Source</h2><p><img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-component-second.png"> 这是我们从浏览器中看到的样子，但是加载的源代码是什么样子的呢。我们查看网页源代码，不是 browser debugger 中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt; div &gt;</span><br><span class="line">    &lt;h1 &gt; Hello World &lt; /h1&gt;</span><br><span class="line">    &lt;script type = &quot;text/x-magento-init&quot; &gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;*&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Magento_Ui/js/core/app&quot;:</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;types&quot;:</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;dataSource&quot;: [],</span><br><span class="line">                    &quot;pulsestorm_simple&quot;:</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;extends&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;html_content&quot;:</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;component&quot;: &quot;Magento_Ui\/js\/form\/components\/html&quot;,</span><br><span class="line">                        &quot;extends&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;components&quot;:</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;pulsestorm_simple&quot;:</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;children&quot;:</span><br><span class="line">                        &#123;</span><br><span class="line">                            &quot;pulsestorm_simple&quot;:</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;type&quot;: &quot;pulsestorm_simple&quot;,</span><br><span class="line">                                &quot;name&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &quot;pulsestorm_simple_data_source&quot;:</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;type&quot;: &quot;dataSource&quot;,</span><br><span class="line">                                &quot;name&quot;: &quot;pulsestorm_simple_data_source&quot;,</span><br><span class="line">                                &quot;dataScope&quot;: &quot;pulsestorm_simple&quot;,</span><br><span class="line">                                &quot;config&quot;:</span><br><span class="line">                                &#123;</span><br><span class="line">                                    &quot;params&quot;:</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        &quot;namespace&quot;: &quot;pulsestorm_simple&quot;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt; /script&gt;</span><br><span class="line">&lt;/div &gt;</span><br></pre></td></tr></table></figure>

<p>Magento 从 XHTML template 中不仅仅是加载了 <code>&lt;div&gt;</code> 和 <code>&lt;h1&gt;</code> 标签，他还载入了一个 <code>text/x-magento-init</code> script 。这是我们今天要讨论的关于 UI component system 的最后一个方面。UI component 不仅加载 XHTML template，也不仅仅是将 template 和 data provider 对象绑定起来，他还加载一个 JSON 对象，通过 <code>x-magento-init</code> 的方式，用这个 JSON 对象来实例化 <code>Magento_Ui/js/core/app</code> RequireJS app&#x2F;module。 现在，我们知道 UI component 做的大致事情了，下面我们来看看这个 template&#x2F;rendering engine 的一些功能。</p>
<h2 id="XHTML-Template-Tags"><a href="#XHTML-Template-Tags" class="headerlink" title="XHTML Template Tags"></a><a href="#xhtml-template-tags"></a>XHTML Template Tags</h2><p>和 <code>phtml</code> 模板类似 —— 你可以在 XHTML 模板中对底层的 UI Component 类进行 “调用”。你可以使用特殊的模板指令 <code>&amp;#123;&amp;#123;...&amp;#125;&amp;#125;</code>。下面我们看个例子，我们给 component 类添加一个 <code>getEvenMoreData</code> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/Component/Simple.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleUiComponent\Component;</span><br><span class="line">class Simple extends \Magento\Ui\Component\AbstractComponent</span><br><span class="line">&#123;</span><br><span class="line">    const NAME = &#x27;pulsestorm_simple&#x27;;</span><br><span class="line">    public function getComponentName()</span><br><span class="line">    &#123;</span><br><span class="line">        return static::NAME;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //added this method</span><br><span class="line">    public function getEvenMoreData()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#x27;Even More Data!&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在 <code>xhtml</code> template 中调用 <code>&amp;#123;&amp;#123;...&amp;#125;&amp;#125;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/templates/our-template.xhtml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Hello World&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &amp;#123;&amp;#123;getComponentName()&amp;#125;&amp;#125;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &amp;#123;&amp;#123;getEvenMoreData()&amp;#125;&amp;#125;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>上面的代码保存后，清空缓存刷新页面。你就会看到类的方法&#x2F;属性中的数据传递到模板上来了。 <img src="/hellomagento2/wp-content/uploads/2018/05/simple-ui-component-third.png"> 除了调用对象中的方法，我们应该还能通过 data 配置节点来获得 data 属性值，就像下面这样。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml --&gt;</span><br><span class="line">&lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">    &lt;item name=&quot;template&quot; xsi:type=&quot;string&quot;&gt;templates/our-template&lt;/item&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- NEW NODE HERE --&gt;</span><br><span class="line">    &lt;item name=&quot;message&quot; xsi:type=&quot;string&quot;&gt;Hello World&lt;/item&gt;</span><br><span class="line">&lt;/argument&gt;</span><br></pre></td></tr></table></figure>

<p>然后再 xhtml 中调用它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">    &amp;#123;&amp;#123;message&amp;#125;&amp;#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>但是，这里有个 <a target="_blank" rel="noopener" href="https://github.com/magento/magento2/issues/6532">bug</a>，除非这个 data variable 在 tag 的属性中，否则加载的还是 <code>&amp;#123;&amp;#123;message&amp;#125;&amp;#125;</code> 而不是它的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div class=&quot;&amp;#123;&amp;#123;message&amp;#125;&amp;#125;&quot;&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">    &amp;#123;&amp;#123;message&amp;#125;&amp;#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>上面这一段 render 出来的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div class=&quot;Hello World&quot;&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">    &amp;#123;&amp;#123;message&amp;#125;&amp;#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>真是很烦人，再次表明 UI Component system 还不成熟。</p>
<h2 id="理解-UI-Component-继承"><a href="#理解-UI-Component-继承" class="headerlink" title="理解 UI Component 继承"></a><a href="#%E7%90%86%E8%A7%A3-ui-component-%E7%BB%A7%E6%89%BF"></a>理解 UI Component 继承</h2><p>在<code>definition.xml</code> 中放置顶级节点，意味着你创建了一个可重用的 UI 组件标签。其他程序员可以在 XML 文件中使用 <code>&lt;uiComponent&gt;</code> 使用你的组件。 <code>definition.xml</code> 文件还可以设置组件的默认值，不过这些值是可以被覆盖的。 举例来说，我们设置了默认的模板：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/base/ui_component/etc/definition.xml --&gt;</span><br><span class="line">&lt;components xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_definition.xsd&quot;&gt;</span><br><span class="line">    &lt;pulsestorm_simple class=&quot;Pulsestorm\SimpleUiComponent\Component\Simple&quot;&gt;</span><br><span class="line">        &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">            &lt;item name=&quot;template&quot; xsi:type=&quot;string&quot;&gt;templates/our-template&lt;/item&gt;</span><br><span class="line">        &lt;/argument&gt;</span><br><span class="line">    &lt;/pulsestorm_simple&gt;</span><br><span class="line">&lt;/components&gt;</span><br></pre></td></tr></table></figure>

<p>假设我们需要一个 <code>pulsestorm_simple</code> 组件，但是我们要换一个 template。那么我们可以按照相同的结构重写一下要用的 template。 比如，我们需要下面的模板：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/templates/different.xhtml --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Hello Brave New World&lt;/h1&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>我们需要做的就是增加下面 template 部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- File: app/code/Pulsestorm/SimpleUiComponent/view/adminhtml/ui_component/pulsestorm_simple.xml --&gt;</span><br><span class="line">&lt;pulsestorm_simple xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:module:Magento_Ui:etc/ui_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;argument name=&quot;data&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">        &lt;item name=&quot;template&quot; xsi:type=&quot;string&quot;&gt;templates/different&lt;/item&gt;</span><br><span class="line">    &lt;/argument&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">&lt;/pulsestorm_simple&gt;</span><br></pre></td></tr></table></figure>

<p>这个功能通常不作用于 template，它常用在配置参数的重写上，并且对于使用至关重要。在实际开发中，你不会向 <code>definition.xml</code> 中加东西，但是 debug grid listing 的参数时，还是需要参考 <code>definition.xml</code> 的。</p>
<h2 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a><a href="#%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE"></a>添加数据</h2><p>今天我们要说的最后一件时 UI Component 的 data 。UI Component 的 data 类似于 grid listing 的行，或是 form 的默认值。Behind the scenes, the UI Component system can render this backend data for you in the frontend as a javascript array&#x2F;object. 我们需要做的就是在 component 类中定义 <code>getDataSourceData</code> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/Component/Simple.php    </span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleUiComponent\Component;</span><br><span class="line">class Simple extends \Magento\Ui\Component\AbstractComponent</span><br><span class="line">&#123;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">    public function getDataSourceData()</span><br><span class="line">    &#123;</span><br><span class="line">        return [&#x27;data&#x27; =&gt; [&#x27;foo&#x27;=&gt;&#x27;bar&#x27;]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>清除缓存并刷新页面后，查看源代码，我们会发现刚刚的 <code>foo =&gt; bar</code> 已经在 JSON 中了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;pulsestorm_simple_data_source&quot;: &#123;</span><br><span class="line">    //...</span><br><span class="line">    &quot;config&quot;: &#123;</span><br><span class="line">        &quot;data&quot;: &#123;</span><br><span class="line">            &quot;foo&quot;: &quot;bar&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    //...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可能会感到很困惑，如果 data 来自于 component 类的 <code>getDataSourceData</code> 方法，那么为什么还要配置 <code>Pulsestorm\SimpleUiComponent\Model\DataProvider</code> 呢？ Alan 也没有好的答案。基于核心代码，看起来正确的使用方式是，在 component 类中获得 data provider 对象，然后调用它的 <code>getData</code> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/Component/Simple.php</span><br><span class="line">public function getDataSourceData()</span><br><span class="line">&#123;</span><br><span class="line">    return [&#x27;data&#x27; =&gt; $this-&gt;getContext()-&gt;getDataProvider()-&gt;getData()];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>data provider 的 <code>getData</code> 方法返回实际的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#File: app/code/Pulsestorm/SimpleUiComponent/Model/DataProvider.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Pulsestorm\SimpleUiComponent\Model;</span><br><span class="line">class DataProvider extends \Magento\Ui\DataProvider\AbstractDataProvider</span><br><span class="line">&#123;</span><br><span class="line">    public function getData()</span><br><span class="line">    &#123;</span><br><span class="line">        return [[&#x27;foo&#x27;=&gt;&#x27;baz&#x27;]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>乍一看，UI Component 系统似乎是一个面向对象的领域专用语言（domain specific language），用来创建用户界面的组件，可能已经朝着这个目的去做了，但是，深入了解后发现，他还没有完成，里面有各种边缘清空，bugs, 奇怪的遗漏。</p>
<h2 id="后续步骤"><a href="#后续步骤" class="headerlink" title="后续步骤"></a><a href="#%E5%90%8E%E7%BB%AD%E6%AD%A5%E9%AA%A4"></a>后续步骤</h2><p>简而言之, 这是 UI Component system 的 PHP 部分。在一天结束时, 所有这些复杂性可以归结为渲染一个 xhtml 模板并将其绑定到数据源上。 在我们的后续文章中，我们将更深入地了解 Magento 的 js 系统（RequireJS 和 knockout.js）是如何与 UI component 系统交互的。这些交互正是 Magento 的 grid listings 和后端 forms 渲染的主要工作，理解这些系统对于自定义后端 UI 是至关重要的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/magento-2-add-custom-validation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/magento-2-add-custom-validation/" class="post-title-link" itemprop="url">Magento 2 add custom validation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-15 18:45:10" itemprop="dateCreated datePublished" datetime="2018-05-15T18:45:10+08:00">2018-05-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>magento 2 的 validation 是基于<a target="_blank" rel="noopener" href="https://jqueryvalidation.org/">jquery validate 插件</a>的。</p>
<h2 id="一般页面的-validation-使用方式"><a href="#一般页面的-validation-使用方式" class="headerlink" title="一般页面的 validation 使用方式"></a><a href="#%E4%B8%80%E8%88%AC%E9%A1%B5%E9%9D%A2%E7%9A%84-validation-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"></a>一般页面的 validation 使用方式</h2><p>对于一般的 <code>phtml</code> 页面来说，我们可以通过如下方法进行验证：</p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a><a href="#%E6%96%B9%E6%B3%95%E4%B8%80"></a>方法一</h3><p>通过 <code>data-validate</code> 属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input data-validate=&#x27;&#123;&quot;required&quot;:true&#125;&#x27;name=&quot;field1&quot; id=&quot;field1&quot; ... /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a><a href="#%E6%96%B9%E6%B3%95%E4%BA%8C"></a>方法二</h3><p>把规则名称放到 class 中去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input class=&quot;input-text required&quot; name=&quot;field3&quot; id=&quot;field3&quot; ... /&gt;</span><br><span class="line">&lt;input class=&quot;input-text required-entry&quot; name=&quot;field3&quot; id=&quot;field3&quot; ... /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a><a href="#%E6%96%B9%E6%B3%95%E4%B8%89"></a>方法三</h3><p>使用规则名作为元素属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input required=&quot;true&quot; name=&quot;field2&quot; id=&quot;field2&quot; ... /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="方法四"><a href="#方法四" class="headerlink" title="方法四"></a><a href="#%E6%96%B9%E6%B3%95%E5%9B%9B"></a>方法四</h3><p>通过在 <code>data-mage-init</code> 中设置规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;form ... data-mage-init=&#x27;&#123;</span><br><span class="line">    &quot;validation&quot;:&#123;</span><br><span class="line">        &quot;rules&quot;: &#123;</span><br><span class="line">            &quot;field4&quot;: &#123;</span><br><span class="line">                &quot;required&quot;:true</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;&gt;</span><br></pre></td></tr></table></figure>

<p>方法一和方法二很常见。 参考文档 <a target="_blank" rel="noopener" href="http://inchoo.net/magento-2/validate-custom-form-in-magento-2/">Validate a custom form in Magento 2</a> 既然是基于 jquery validate plugin 的，那么他的一些方法还是管用的，比如我想自定义错误信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input data-validate=&#x27;&#123;&quot;required&quot;:true&#125;&#x27;name=&quot;field1&quot; id=&quot;field1&quot; data-msg-required=&quot;我是自定义的错误信息&quot;... /&gt;</span><br></pre></td></tr></table></figure>

<h2 id="增加自定义的-validation"><a href="#增加自定义的-validation" class="headerlink" title="增加自定义的 validation"></a><a href="#%E5%A2%9E%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-validation"></a>增加自定义的 validation</h2><p>假设我想给 telephone 字段增加一个自定义的规则，那么对于这个页面，我可以这样做：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">requirejs([&#x27;jquery&#x27;], function ($) &#123;</span><br><span class="line">    $.validator.addMethod(</span><br><span class="line">        &#x27;phoneCN&#x27;, function (value) &#123;</span><br><span class="line">            if(value.match(/^1\d&#123;10&#125;$/))&#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, &#x27;请输入正确的手机号&#x27;);</span><br><span class="line"></span><br><span class="line">    $(&#x27;#telephone&#x27;).attr(&#x27;data-validate&#x27;, &quot;&#123;required:true, &#x27;phoneCN&#x27;:true&#125;&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在这个页面上，我们增加一个新的规则 <code>phoneCN</code> 并且把这个规则加到元素的 <code>data-validate</code> 中去。 但是如果我希望把这个规则合并到全局中去，就像 <code>required</code> 规则一样，该怎么做呢？</p>
<h2 id="增加全局的-validation"><a href="#增加全局的-validation" class="headerlink" title="增加全局的 validation"></a><a href="#%E5%A2%9E%E5%8A%A0%E5%85%A8%E5%B1%80%E7%9A%84-validation"></a>增加全局的 validation</h2><p>上面提到普通页面的用法，那么肯定是有不普通的页面了。是的，不普通的页面包括 checkout 页面和 Admin 后台。他们都是通过 Magento_Ui 这个模块来 render 这些组件的。 普通页面用到的 validation 主要是 <code>mage/validation</code> 即 <code>lib\web\mage\validation.js</code> 其他页面用到的是 <code>Magento_Ui/js/lib/validation/validator</code> 下面我们就通过 mixins 将 <code>phoneCN</code> 规则加进去。 关于 Mixin ，参考这里 <a target="_blank" rel="noopener" href="https://alanstorm.com/the-curious-case-of-magento-2-mixins/">The Curious Case of Magento 2 Mixins</a> File: app\code\Vendor\PhoneCNValidate\view\base\requirejs-config.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var config = &#123;</span><br><span class="line">    config: &#123;</span><br><span class="line">        mixins: &#123;</span><br><span class="line">            &#x27;mage/validation&#x27;: &#123;</span><br><span class="line">                &#x27;Vendor_PhoneCNValidate/js/lib/mage/validation-mixin&#x27;: true</span><br><span class="line">            &#125;,</span><br><span class="line">            &#x27;Magento_Ui/js/lib/validation/validator&#x27;: &#123;</span><br><span class="line">                &#x27;Vendor_PhoneCNValidate/js/lib/mage/validator-mixin&#x27;: true</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>File: app\code\Vendor\PhoneCNValidate\view\base\web\js\lib\mage\validation-mixin.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">define([</span><br><span class="line">    &#x27;jquery&#x27;</span><br><span class="line">], function ($) &#123;</span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line"></span><br><span class="line">    return function () &#123;</span><br><span class="line">        $.validator.addMethod(</span><br><span class="line">            &#x27;phoneCN&#x27;,</span><br><span class="line">            function (phoneNumber, element) &#123;</span><br><span class="line">                return this.optional(element)  phoneNumber.match(/^1\d&#123;10&#125;$/);</span><br><span class="line">            &#125;,</span><br><span class="line">            $.mage.__(&#x27;Please specify a valid phone number&#x27;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>File: app\code\Vendor\PhoneCNValidate\view\base\web\js\lib\mage\validator-mixin.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">define([</span><br><span class="line">    &#x27;jquery&#x27;</span><br><span class="line">], function ($) &#123;</span><br><span class="line">    &#x27;use strict&#x27;;</span><br><span class="line"></span><br><span class="line">    return function (validator) &#123;</span><br><span class="line">        validator.addRule(</span><br><span class="line">            &#x27;phoneCN&#x27;,</span><br><span class="line">            function (value) &#123;</span><br><span class="line">                return value.match(/^1\d&#123;10&#125;$/);</span><br><span class="line">            &#125;,</span><br><span class="line">            $.mage.__(&#x27;Please specify a valid phone number&#x27;)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        return validator;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样普通页面，通过上面的四种方法，就可以调用自定义的验证。 核心代码中并没有把 <code>validate_rules</code> （本文最后一部分会提到）中的值转化成表单控件的 class 名，参看<code>vendor\magento\module-custom-attribute-management\Block\Form\Renderer\AbstractRenderer.php #135</code>，所以我们需要自己修。 下面我们要说不普通的页面了。</p>
<h2 id="checkout-页中加入自定义验证"><a href="#checkout-页中加入自定义验证" class="headerlink" title="checkout 页中加入自定义验证"></a><a href="#checkout-%E9%A1%B5%E4%B8%AD%E5%8A%A0%E5%85%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E9%AA%8C%E8%AF%81"></a>checkout 页中加入自定义验证</h2><p>比如给 checkout 的 address 的 telephone 加 <code>phoneCN</code> 验证 File: app\code\Vendor\PhoneCNValidate\view\frontend\layout\checkout_index_index.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;page xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; layout=&quot;checkout&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:framework:View/Layout/etc/page_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;referenceBlock name=&quot;checkout.root&quot;&gt;</span><br><span class="line">            &lt;arguments&gt;</span><br><span class="line">                &lt;argument name=&quot;jsLayout&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                    &lt;item name=&quot;components&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                        &lt;item name=&quot;checkout&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                            &lt;item name=&quot;children&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                &lt;item name=&quot;steps&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                    &lt;item name=&quot;children&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                        &lt;item name=&quot;shipping-step&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                            &lt;item name=&quot;children&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                                &lt;item name=&quot;shippingAddress&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                                    &lt;item name=&quot;children&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                                        &lt;item name=&quot;shipping-address-fieldset&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                                            &lt;item name=&quot;children&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                                                &lt;item name=&quot;telephone&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                                                    &lt;item name=&quot;validation&quot; xsi:type=&quot;array&quot;&gt;</span><br><span class="line">                                                                        &lt;item name=&quot;phoneCN&quot; xsi:type=&quot;number&quot;&gt;1&lt;/item&gt;</span><br><span class="line">                                                                    &lt;/item&gt;</span><br><span class="line">                                                                &lt;/item&gt;</span><br><span class="line">                                                            &lt;/item&gt;</span><br><span class="line">                                                        &lt;/item&gt;</span><br><span class="line">                                                    &lt;/item&gt;</span><br><span class="line">                                                &lt;/item&gt;</span><br><span class="line">                                            &lt;/item&gt;</span><br><span class="line">                                        &lt;/item&gt;</span><br><span class="line">                                    &lt;/item&gt;</span><br><span class="line">                                &lt;/item&gt;</span><br><span class="line">                            &lt;/item&gt;</span><br><span class="line">                        &lt;/item&gt;</span><br><span class="line">                    &lt;/item&gt;</span><br><span class="line">                &lt;/argument&gt;</span><br><span class="line">            &lt;/arguments&gt;</span><br><span class="line">        &lt;/referenceBlock&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/page&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Admin-后台-Customer-Address"><a href="#Admin-后台-Customer-Address" class="headerlink" title="Admin 后台 Customer Address"></a><a href="#admin-%E5%90%8E%E5%8F%B0-customer-address"></a>Admin 后台 Customer Address</h2><p>File: app\code\Vendor\PhoneCNValidate\Setup\InstallData.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * Copyright © Isobar Commerce, Inc. All rights reserved.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">namespace Vendor\PhoneCNValidate\Setup;</span><br><span class="line"></span><br><span class="line">use Magento\Framework\Setup\InstallDataInterface;</span><br><span class="line">use Magento\Framework\Setup\ModuleContextInterface;</span><br><span class="line">use Magento\Framework\Setup\ModuleDataSetupInterface;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class InstallData implements InstallDataInterface</span><br><span class="line">&#123;</span><br><span class="line">    protected $eavSetupFactory;</span><br><span class="line"></span><br><span class="line">    public function __construct(</span><br><span class="line">        \Magento\Eav\Setup\EavSetupFactory $eavSetupFactory</span><br><span class="line">    ) &#123;</span><br><span class="line">        $this-&gt;eavSetupFactory = $eavSetupFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function install(</span><br><span class="line">        ModuleDataSetupInterface $setup,</span><br><span class="line">        ModuleContextInterface $context</span><br><span class="line">    ) &#123;</span><br><span class="line">        $eavSetup = $this-&gt;eavSetupFactory-&gt;create([&#x27;setup&#x27; =&gt; $setup]);</span><br><span class="line">        // work in admin backend</span><br><span class="line">        // $eavSetup-&gt;updateAttribute(&#x27;customer&#x27;, &#x27;telephone&#x27;, &#x27;validate_rules&#x27;, &#x27;&#123;&quot;phoneCN&quot;:true&#125;&#x27;);</span><br><span class="line">        $eavSetup-&gt;updateAttribute(&#x27;customer_address&#x27;, &#x27;telephone&#x27;, &#x27;validate_rules&#x27;, &#x27;&#123;&quot;phoneCN&quot;:true&#125;&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是说后台的验证规则是和数据库中的记录相关的。 表 <code>eav_attribute</code> 和 <code>customer_eav_attribute</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/js-translation-json-%E6%9C%AA%E6%9B%B4%E6%96%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/js-translation-json-%E6%9C%AA%E6%9B%B4%E6%96%B0/" class="post-title-link" itemprop="url">js-translation.json 未更新</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-14 14:28:35" itemprop="dateCreated datePublished" datetime="2018-05-14T14:28:35+08:00">2018-05-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>js-tanslation.json</code> 用于前端的翻译。 比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;span data-bind=&quot;i18n:&#x27;Place order now&#x27;&quot;&gt;&lt;/span&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.mage.__(&#x27;Please enter a valid email %1 address (Ex: johndoe@domain.com).&#x27;)</span><br></pre></td></tr></table></figure>

<p>它是根据 csv 自动生成的。但是改动 csv 文件后，有很多时候 <code>js-translation.json</code> 却没有更新。 这里记一下，<code>developer</code> 模式下，让它更新的办法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php bin/magento cache:clean</span><br><span class="line">rm -rf pub/static/*</span><br><span class="line">rm -rf var/view_preprocessed/*</span><br><span class="line">php bin/magento setup:static-content:deploy -f</span><br></pre></td></tr></table></figure>

<p>要义是使 <code>js-translation.json</code> 删除并重新生成。 如果还不更新，考虑浏览器端缓存，清空缓存并硬性重新加载。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/top-links%E5%8A%A0%E5%85%A5%E9%93%BE%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/top-links%E5%8A%A0%E5%85%A5%E9%93%BE%E6%8E%A5/" class="post-title-link" itemprop="url">top.links 加入链接</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-11 17:54:40" itemprop="dateCreated datePublished" datetime="2018-05-11T17:54:40+08:00">2018-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;page xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:framework:View/Layout/etc/page_configuration.xsd&quot;&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;referenceBlock name=&quot;top.links&quot;&gt;</span><br><span class="line">            &lt;block class=&quot;Magento\Customer\Block\Account\SortLink&quot; name=&quot;my-order&quot;&gt;</span><br><span class="line">                &lt;arguments&gt;</span><br><span class="line">                    &lt;argument name=&quot;path&quot; xsi:type=&quot;string&quot;&gt;sales/order/history&lt;/argument&gt;</span><br><span class="line">                    &lt;argument name=&quot;label&quot; xsi:type=&quot;string&quot; translate=&quot;true&quot;&gt;My Orders&lt;/argument&gt;</span><br><span class="line">                    &lt;argument name=&quot;sortOrder&quot; xsi:type=&quot;number&quot;&gt;70&lt;/argument&gt;</span><br><span class="line">                &lt;/arguments&gt;</span><br><span class="line">            &lt;/block&gt;</span><br><span class="line">        &lt;/referenceBlock&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/page&gt;</span><br></pre></td></tr></table></figure>

<p>排列顺序是按照 <code>sortOrder</code> 由大到小的。 比如 My Account 110 排在 My Wish Lists 60 之前。 <img src="/hellomagento2/wp-content/uploads/2018/05/top.links_.sort_.order_.png" alt="default top links sort order"></p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a><a href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"></a>相关链接</h2><p><a target="_blank" rel="noopener" href="https://github.com/magento/magento2/issues/11431#issuecomment-388271300">https://github.com/magento/magento2/issues/11431#issuecomment-388271300</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://piscesthankit.github.io/hellomagento2/php-ssl-certificate-error-unable-to-get-local-issuer-certificate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hellomagento2/images/avatar.gif">
      <meta itemprop="name" content="ThankIT">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="{ Hello Magento 2 }">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hellomagento2/php-ssl-certificate-error-unable-to-get-local-issuer-certificate/" class="post-title-link" itemprop="url">PHP - SSL certificate error unable to get local issuer certificate</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-07 17:00:41" itemprop="dateCreated datePublished" datetime="2018-05-07T17:00:41+08:00">2018-05-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hellomagento2/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>WAMP worked!</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/32095378">Solution</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/hellomagento2/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/hellomagento2/">1</a><span class="space">&hellip;</span><a class="page-number" href="/hellomagento2/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/hellomagento2/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/hellomagento2/page/32/">32</a><a class="extend next" rel="next" href="/hellomagento2/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ThankIT</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/hellomagento2/archives/">
        
          <span class="site-state-item-count">313</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/hellomagento2/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/hellomagento2/tags/">
          
        <span class="site-state-item-count">136</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ThankIT</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/hellomagento2/lib/anime.min.js"></script>
  <script src="/hellomagento2/lib/velocity/velocity.min.js"></script>
  <script src="/hellomagento2/lib/velocity/velocity.ui.min.js"></script>

<script src="/hellomagento2/js/utils.js"></script>

<script src="/hellomagento2/js/motion.js"></script>


<script src="/hellomagento2/js/schemes/pisces.js"></script>


<script src="/hellomagento2/js/next-boot.js"></script>




  




  
<script src="/hellomagento2/js/local-search.js"></script>













  

  

</body>
</html>
